{"version":3,"file":"index.js","sources":["../../../core/dist/vue/index.js","../../src/vue/hooks/use-render.ts","../../src/vue/components/render-layer.vue"],"sourcesContent":["import { inject as p, ref as u, onMounted as a, onBeforeUnmount as l, shallowRef as d, watch as v, computed as y, defineComponent as m, provide as P, renderSlot as w } from \"vue\";\nimport { a as h, P as S } from \"../math-ChSRQF3r.js\";\nconst f = Symbol(\"pdfKey\");\nfunction c() {\n  const r = p(f);\n  if (!r) throw new Error(\"useRegistry must be used inside <EmbedPDF>\");\n  return r;\n}\nfunction b() {\n  const { registry: r } = c(), e = u();\n  return a(() => {\n    const o = r.value.getStore();\n    e.value = o.getState().core;\n    const t = o.subscribe((s, n, i) => {\n      o.isCoreAction(s) && !h(n.core, i.core) && (e.value = n.core);\n    });\n    l(t);\n  }), e;\n}\nfunction R(r) {\n  const { registry: e } = c(), o = d(null), t = u(!0), s = u(new Promise(() => {\n  })), n = () => {\n    var g;\n    if (!e.value) return;\n    const i = e.value.getPlugin(r);\n    if (!i) throw new Error(`Plugin ${r} not found`);\n    o.value = i, t.value = !1, s.value = ((g = i.ready) == null ? void 0 : g.call(i)) ?? Promise.resolve();\n  };\n  return a(n), v(e, n), { plugin: o, isLoading: t, ready: s };\n}\nfunction z(r) {\n  const { plugin: e, isLoading: o, ready: t } = R(r);\n  return { provides: y(() => {\n    if (!e.value) return null;\n    if (!e.value.provides)\n      throw new Error(`Plugin ${r} does not implement provides()`);\n    return e.value.provides();\n  }), isLoading: o, ready: t };\n}\nfunction C() {\n  const { registry: r } = c(), e = u();\n  function o() {\n    return r.value ? (e.value = r.value.getStore().getState(), r.value.getStore().subscribe((s, n) => e.value = n)) : () => {\n    };\n  }\n  let t = o();\n  return v(r, () => {\n    t == null || t(), t = o();\n  }), l(() => t == null ? void 0 : t()), e;\n}\nconst F = /* @__PURE__ */ m({\n  __name: \"embed-pdf\",\n  props: {\n    engine: {},\n    plugins: {},\n    onInitialized: { type: Function }\n  },\n  setup(r) {\n    const e = r, o = d(null), t = u(!0), s = u(!1);\n    return P(f, { registry: o, isInitializing: t, pluginsReady: s }), a(async () => {\n      var i;\n      const n = new S(e.engine);\n      n.registerPluginBatch(e.plugins), await n.initialize(), await ((i = e.onInitialized) == null ? void 0 : i.call(e, n)), o.value = n, t.value = !1, n.pluginsReady().then(() => s.value = !0);\n    }), l(() => {\n      var n;\n      return (n = o.value) == null ? void 0 : n.destroy();\n    }), (n, i) => w(n.$slots, \"default\", {\n      registry: o.value,\n      isInitializing: t.value,\n      pluginsReady: s.value\n    });\n  }\n});\nexport {\n  F as EmbedPDF,\n  z as useCapability,\n  b as useCoreState,\n  R as usePlugin,\n  c as useRegistry,\n  C as useStoreState\n};\n//# sourceMappingURL=index.js.map\n","import { useCapability, usePlugin } from '@embedpdf/core/vue';\nimport { RenderPlugin } from '@embedpdf/plugin-render';\n\nexport const useRenderPlugin = () => usePlugin<RenderPlugin>(RenderPlugin.id);\nexport const useRenderCapability = () => useCapability<RenderPlugin>(RenderPlugin.id);\n","<script setup lang=\"ts\">\nimport { ref, watch, onBeforeUnmount } from 'vue';\nimport { ignore, PdfErrorCode, PdfErrorReason, Task } from '@embedpdf/models';\n\nimport { useRenderCapability } from '../hooks';\n\ninterface Props {\n  pageIndex: number;\n  scaleFactor?: number;\n  dpr?: number;\n}\n\nconst props = withDefaults(defineProps<Props>(), {\n  scaleFactor: 1,\n  dpr: 1,\n});\n\nconst { provides: renderProvides } = useRenderCapability();\n\nconst imageUrl = ref<string | null>(null);\nlet currentBlobUrl: string | null = null;\nlet currentTask: Task<Blob, PdfErrorReason> | null = null; // Track current render task\n\n/* ------------------------------------------ */\n/* Helper function to abort current task */\n/* ------------------------------------------ */\nfunction abortCurrentTask() {\n  if (currentTask && !currentBlobUrl) {\n    currentTask.abort({\n      code: PdfErrorCode.Cancelled,\n      message: 'canceled render task',\n    });\n  }\n}\n\n/* ------------------------------------------ */\n/* render whenever pageIndex/scale/dpr change */\n/* ------------------------------------------ */\nfunction revoke() {\n  if (currentBlobUrl) {\n    URL.revokeObjectURL(currentBlobUrl);\n    currentBlobUrl = null;\n  }\n}\n\nfunction startRender() {\n  // Abort any existing task\n  abortCurrentTask();\n\n  revoke();\n  imageUrl.value = null;\n  currentTask = null;\n\n  if (!renderProvides.value) return;\n\n  const task = renderProvides.value.renderPage({\n    pageIndex: props.pageIndex,\n    scaleFactor: props.scaleFactor,\n    dpr: props.dpr,\n  });\n\n  currentTask = task;\n\n  task.wait((blob) => {\n    currentBlobUrl = URL.createObjectURL(blob);\n    imageUrl.value = currentBlobUrl;\n    currentTask = null; // Task completed\n  }, ignore);\n}\n\nwatch(() => [props.pageIndex, props.scaleFactor, props.dpr, renderProvides.value], startRender, {\n  immediate: true,\n});\n\n/* ------------------------------------------ */\nonBeforeUnmount(() => {\n  // Abort any pending task when component unmounts\n  abortCurrentTask();\n  revoke();\n});\n</script>\n\n<template>\n  <img v-if=\"imageUrl\" :src=\"imageUrl\" :style=\"{ width: '100%', height: '100%' }\" @load=\"revoke\" />\n</template>\n"],"names":["f","c","p","R","d","t","u","s","n","g","i","a","v","z","y","useRenderPlugin","usePlugin","RenderPlugin","useRenderCapability","useCapability","props","__props","renderProvides","imageUrl","ref","currentBlobUrl","currentTask","abortCurrentTask","PdfErrorCode","revoke","startRender","task","blob","ignore","watch","onBeforeUnmount","_createElementBlock"],"mappings":";;AAEA,MAAMA,IAAI,OAAO,QAAQ;AACzB,SAASC,IAAI;AACX,QAAM,IAAIC,EAAEF,CAAC;AACb,MAAI,CAAC,EAAG,OAAM,IAAI,MAAM,4CAA4C;AACpE,SAAO;AACT;AAYA,SAASG,EAAE,GAAG;AACZ,QAAM,EAAE,UAAU,EAAC,IAAKF,EAAC,GAAI,IAAIG,EAAE,IAAI,GAAGC,IAAIC,EAAE,EAAE,GAAGC,IAAID,EAAE,IAAI,QAAQ,MAAM;AAAA,EAC7E,CAAC,CAAC,GAAGE,IAAI,MAAM;AACb,QAAIC;AACJ,QAAI,CAAC,EAAE,MAAO;AACd,UAAMC,IAAI,EAAE,MAAM,UAAU,CAAC;AAC7B,QAAI,CAACA,EAAG,OAAM,IAAI,MAAM,UAAU,CAAC,YAAY;AAC/C,MAAE,QAAQA,GAAGL,EAAE,QAAQ,IAAIE,EAAE,UAAUE,IAAIC,EAAE,UAAU,OAAO,SAASD,EAAE,KAAKC,CAAC,MAAM,QAAQ,QAAO;AAAA,EACtG;AACA,SAAOC,EAAEH,CAAC,GAAGI,EAAE,GAAGJ,CAAC,GAAG,EAAE,QAAQ,GAAG,WAAWH,GAAG,OAAOE,EAAC;AAC3D;AACA,SAASM,EAAE,GAAG;AACZ,QAAM,EAAE,QAAQ,GAAG,WAAW,GAAG,OAAOR,EAAC,IAAKF,EAAE,CAAC;AACjD,SAAO,EAAE,UAAUW,EAAE,MAAM;AACzB,QAAI,CAAC,EAAE,MAAO,QAAO;AACrB,QAAI,CAAC,EAAE,MAAM;AACX,YAAM,IAAI,MAAM,UAAU,CAAC,gCAAgC;AAC7D,WAAO,EAAE,MAAM,SAAQ;AAAA,EACzB,CAAC,GAAG,WAAW,GAAG,OAAOT,EAAC;AAC5B;ACnCO,MAAMU,IAAkB,MAAMC,EAAwBC,EAAa,EAAE,GAC/DC,IAAsB,MAAMC,EAA4BF,EAAa,EAAE;;;;;;;;ACQpF,UAAMG,IAAQC,GAKR,EAAE,UAAUC,EAAA,IAAmBJ,EAAA,GAE/BK,IAAWC,EAAmB,IAAI;AACxC,QAAIC,IAAgC,MAChCC,IAAiD;AAKrD,aAASC,IAAmB;AAC1B,MAAID,KAAe,CAACD,KAClBC,EAAY,MAAM;AAAA,QAChB,MAAME,EAAa;AAAA,QACnB,SAAS;AAAA,MAAA,CACV;AAAA,IAEL;AAKA,aAASC,IAAS;AAChB,MAAIJ,MACF,IAAI,gBAAgBA,CAAc,GAClCA,IAAiB;AAAA,IAErB;AAEA,aAASK,IAAc;AAQrB,UANAH,EAAA,GAEAE,EAAA,GACAN,EAAS,QAAQ,MACjBG,IAAc,MAEV,CAACJ,EAAe,MAAO;AAE3B,YAAMS,IAAOT,EAAe,MAAM,WAAW;AAAA,QAC3C,WAAWF,EAAM;AAAA,QACjB,aAAaA,EAAM;AAAA,QACnB,KAAKA,EAAM;AAAA,MAAA,CACZ;AAED,MAAAM,IAAcK,GAEdA,EAAK,KAAK,CAACC,MAAS;AAClB,QAAAP,IAAiB,IAAI,gBAAgBO,CAAI,GACzCT,EAAS,QAAQE,GACjBC,IAAc;AAAA,MAChB,GAAGO,CAAM;AAAA,IACX;AAEA,WAAAC,EAAM,MAAM,CAACd,EAAM,WAAWA,EAAM,aAAaA,EAAM,KAAKE,EAAe,KAAK,GAAGQ,GAAa;AAAA,MAC9F,WAAW;AAAA,IAAA,CACZ,GAGDK,EAAgB,MAAM;AAEpB,MAAAR,EAAA,GACAE,EAAA;AAAA,IACF,CAAC,aAIYN,EAAA,cAAXa,EAAiG,OAAA;AAAA;MAA3E,KAAKb,EAAA;AAAA,MAAW,OAAO,EAAA,OAAA,QAAA,QAAA,OAAA;AAAA,MAAoC,QAAMM;AAAA,IAAA;;;"}