{"version":3,"file":"index.cjs","sources":["../../../core/dist/preact/index.js","../../src/preact/hooks/use-render.ts","../../src/preact/components/render-layer.tsx"],"sourcesContent":["import { createContext as b } from \"preact\";\nimport { u as w } from \"../jsxRuntime.module-Bzuv3cXw.js\";\nimport { useState as a, useRef as m, useEffect as f, useContext as S } from \"preact/hooks\";\nimport { P as v, a as C } from \"../math-ChSRQF3r.js\";\nconst P = b({\n  registry: null,\n  isInitializing: !0,\n  pluginsReady: !1\n});\nfunction F({ engine: t, onInitialized: r, plugins: e, children: i }) {\n  const [o, s] = a(null), [u, c] = a(!0), [y, d] = a(!1), l = m(r);\n  return f(() => {\n    l.current = r;\n  }, [r]), f(() => {\n    const n = new v(t);\n    return n.registerPluginBatch(e), (async () => {\n      var p;\n      await n.initialize(), !n.isDestroyed() && (await ((p = l.current) == null ? void 0 : p.call(l, n)), !n.isDestroyed() && (n.pluginsReady().then(() => {\n        n.isDestroyed() || d(!0);\n      }), s(n), c(!1)));\n    })().catch(console.error), () => {\n      n.destroy(), s(null), c(!0), d(!1);\n    };\n  }, [t, e]), /* @__PURE__ */ w(P.Provider, { value: { registry: o, isInitializing: u, pluginsReady: y }, children: typeof i == \"function\" ? i({ registry: o, isInitializing: u, pluginsReady: y }) : i });\n}\nfunction g() {\n  const t = S(P);\n  if (t === void 0)\n    throw new Error(\"useCapability must be used within a PDFContext.Provider\");\n  const { registry: r, isInitializing: e } = t;\n  if (e)\n    return t;\n  if (r === null)\n    throw new Error(\"PDF registry failed to initialize properly\");\n  return t;\n}\nfunction h(t) {\n  const { registry: r } = g();\n  if (r === null)\n    return {\n      plugin: null,\n      isLoading: !0,\n      ready: new Promise(() => {\n      })\n    };\n  const e = r.getPlugin(t);\n  if (!e)\n    throw new Error(`Plugin ${t} not found`);\n  return {\n    plugin: e,\n    isLoading: !1,\n    ready: e.ready()\n  };\n}\nfunction L(t) {\n  const { plugin: r, isLoading: e, ready: i } = h(t);\n  if (!r)\n    return {\n      provides: null,\n      isLoading: e,\n      ready: i\n    };\n  if (!r.provides)\n    throw new Error(`Plugin ${t} does not provide a capability`);\n  return {\n    provides: r.provides(),\n    isLoading: e,\n    ready: i\n  };\n}\nfunction V() {\n  const { registry: t } = g(), [r, e] = a(null);\n  return f(() => {\n    if (!t) return;\n    e(t.getStore().getState());\n    const i = t.getStore().subscribe((o, s) => {\n      e(s);\n    });\n    return () => i();\n  }, [t]), r;\n}\nfunction $() {\n  const { registry: t } = g(), [r, e] = a(null);\n  return f(() => {\n    if (!t) return;\n    const i = t.getStore();\n    e(i.getState().core);\n    const o = i.subscribe((s, u, c) => {\n      i.isCoreAction(s) && !C(u.core, c.core) && e(u.core);\n    });\n    return () => o();\n  }, [t]), r;\n}\nexport {\n  F as EmbedPDF,\n  P as PDFContext,\n  L as useCapability,\n  $ as useCoreState,\n  h as usePlugin,\n  g as useRegistry,\n  V as useStoreState\n};\n//# sourceMappingURL=index.js.map\n","import { useCapability, usePlugin } from '@embedpdf/core/preact';\nimport { RenderPlugin } from '@embedpdf/plugin-render';\n\nexport const useRenderPlugin = () => usePlugin<RenderPlugin>(RenderPlugin.id);\nexport const useRenderCapability = () => useCapability<RenderPlugin>(RenderPlugin.id);\n","/** @jsxImportSource preact */\nimport { Fragment, JSX } from 'preact';\nimport { useEffect, useRef, useState } from 'preact/hooks';\nimport { ignore, PdfErrorCode } from '@embedpdf/models';\n\nimport { useRenderCapability } from '../hooks/use-render';\n\ntype RenderLayoutProps = Omit<JSX.HTMLAttributes<HTMLImageElement>, 'style'> & {\n  pageIndex: number;\n  scaleFactor?: number;\n  dpr?: number;\n  style?: JSX.CSSProperties;\n};\n\nexport function RenderLayer({\n  pageIndex,\n  scaleFactor = 1,\n  dpr = 1,\n  style,\n  ...props\n}: RenderLayoutProps) {\n  const { provides: renderProvides } = useRenderCapability();\n  const [imageUrl, setImageUrl] = useState<string | null>(null);\n  const urlRef = useRef<string | null>(null);\n\n  useEffect(() => {\n    if (renderProvides) {\n      const task = renderProvides.renderPage({ pageIndex, scaleFactor, dpr });\n      task.wait((blob) => {\n        const url = URL.createObjectURL(blob);\n        setImageUrl(url);\n        urlRef.current = url;\n      }, ignore);\n\n      return () => {\n        if (urlRef.current) {\n          URL.revokeObjectURL(urlRef.current);\n          urlRef.current = null;\n        } else {\n          task.abort({\n            code: PdfErrorCode.Cancelled,\n            message: 'canceled render task',\n          });\n        }\n      };\n    }\n  }, [pageIndex, scaleFactor, dpr, renderProvides]);\n\n  const handleImageLoad = () => {\n    if (urlRef.current) {\n      URL.revokeObjectURL(urlRef.current);\n      urlRef.current = null;\n    }\n  };\n\n  return (\n    <Fragment>\n      {imageUrl && (\n        <img\n          src={imageUrl}\n          onLoad={handleImageLoad}\n          {...props}\n          style={{\n            width: '100%',\n            height: '100%',\n            ...(style || {}),\n          }}\n        />\n      )}\n    </Fragment>\n  );\n}\n"],"names":["P","b","g","t","S","e","h","L","i","useRenderPlugin","usePlugin","RenderPlugin","useRenderCapability","useCapability","RenderLayer","pageIndex","scaleFactor","dpr","style","props","renderProvides","imageUrl","setImageUrl","useState","urlRef","useRef","useEffect","task","blob","url","ignore","PdfErrorCode","handleImageLoad","jsx","Fragment"],"mappings":"8NAIMA,EAAIC,EAAAA,cAAE,CACV,SAAU,KACV,eAAgB,GAChB,aAAc,EAChB,CAAC,EAiBD,SAASC,GAAI,CACX,MAAMC,EAAIC,EAAAA,WAAEJ,CAAC,EACb,GAAIG,IAAM,OACR,MAAM,IAAI,MAAM,yDAAyD,EAC3E,KAAM,CAAE,SAAU,EAAG,eAAgBE,CAAC,EAAKF,EAC3C,GAAIE,EACF,OAAOF,EACT,GAAI,IAAM,KACR,MAAM,IAAI,MAAM,4CAA4C,EAC9D,OAAOA,CACT,CACA,SAASG,EAAEH,EAAG,CACZ,KAAM,CAAE,SAAU,CAAC,EAAKD,EAAC,EACzB,GAAI,IAAM,KACR,MAAO,CACL,OAAQ,KACR,UAAW,GACX,MAAO,IAAI,QAAQ,IAAM,CACzB,CAAC,CACP,EACE,MAAMG,EAAI,EAAE,UAAUF,CAAC,EACvB,GAAI,CAACE,EACH,MAAM,IAAI,MAAM,UAAUF,CAAC,YAAY,EACzC,MAAO,CACL,OAAQE,EACR,UAAW,GACX,MAAOA,EAAE,MAAK,CAClB,CACA,CACA,SAASE,EAAEJ,EAAG,CACZ,KAAM,CAAE,OAAQ,EAAG,UAAWE,EAAG,MAAOG,CAAC,EAAKF,EAAEH,CAAC,EACjD,GAAI,CAAC,EACH,MAAO,CACL,SAAU,KACV,UAAWE,EACX,MAAOG,CACb,EACE,GAAI,CAAC,EAAE,SACL,MAAM,IAAI,MAAM,UAAUL,CAAC,gCAAgC,EAC7D,MAAO,CACL,SAAU,EAAE,SAAQ,EACpB,UAAWE,EACX,MAAOG,CACX,CACA,CClEO,MAAMC,EAAkB,IAAMC,EAAwBC,EAAAA,aAAa,EAAE,EAC/DC,EAAsB,IAAMC,EAA4BF,EAAAA,aAAa,EAAE,ECU7E,SAASG,EAAY,CAC1B,UAAAC,EACA,YAAAC,EAAc,EACd,IAAAC,EAAM,EACN,MAAAC,EACA,GAAGC,CACL,EAAsB,CACpB,KAAM,CAAE,SAAUC,CAAA,EAAmBR,EAAA,EAC/B,CAACS,EAAUC,CAAW,EAAIC,EAAAA,SAAwB,IAAI,EACtDC,EAASC,EAAAA,OAAsB,IAAI,EAEzCC,EAAAA,UAAU,IAAM,CACd,GAAIN,EAAgB,CAClB,MAAMO,EAAOP,EAAe,WAAW,CAAE,UAAAL,EAAW,YAAAC,EAAa,IAAAC,EAAK,EACtE,OAAAU,EAAK,KAAMC,GAAS,CAClB,MAAMC,EAAM,IAAI,gBAAgBD,CAAI,EACpCN,EAAYO,CAAG,EACfL,EAAO,QAAUK,CACnB,EAAGC,EAAAA,MAAM,EAEF,IAAM,CACPN,EAAO,SACT,IAAI,gBAAgBA,EAAO,OAAO,EAClCA,EAAO,QAAU,MAEjBG,EAAK,MAAM,CACT,KAAMI,EAAAA,aAAa,UACnB,QAAS,sBAAA,CACV,CAEL,CACF,CACF,EAAG,CAAChB,EAAWC,EAAaC,EAAKG,CAAc,CAAC,EAEhD,MAAMY,EAAkB,IAAM,CACxBR,EAAO,UACT,IAAI,gBAAgBA,EAAO,OAAO,EAClCA,EAAO,QAAU,KAErB,EAEA,OACES,EAAAA,EAACC,EAAAA,UACE,SAAAb,GACCY,EAAAA,EAAC,MAAA,CACC,IAAKZ,EACL,OAAQW,EACP,GAAGb,EACJ,MAAO,CACL,MAAO,OACP,OAAQ,OACR,GAAID,GAAS,CAAA,CAAC,CAChB,CAAA,EAGN,CAEJ"}