"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const T=require("@embedpdf/models");class R{constructor(){this.dependencyGraph=new Map}addNode(t,e=[]){this.dependencyGraph.set(t,new Set(e))}hasCircularDependencies(){const t=new Set,e=new Set,i=r=>{t.add(r),e.add(r);const n=this.dependencyGraph.get(r)||new Set;for(const o of n)if(t.has(o)){if(e.has(o))return!0}else if(i(o))return!0;return e.delete(r),!1};for(const r of this.dependencyGraph.keys())if(!t.has(r)&&i(r))return!0;return!1}resolveLoadOrder(){if(this.hasCircularDependencies())throw new Error("Circular dependencies detected");const t=[],e=new Set,i=new Set,r=n=>{if(i.has(n))throw new Error("Circular dependency");if(e.has(n))return;i.add(n);const o=this.dependencyGraph.get(n)||new Set;for(const a of o)r(a);i.delete(n),e.add(n),t.push(n)};for(const n of this.dependencyGraph.keys())e.has(n)||r(n);return t}}class l extends Error{constructor(t){super(t),this.name="PluginRegistrationError"}}class d extends Error{constructor(t){super(t),this.name="PluginNotFoundError"}}class A extends Error{constructor(t){super(t),this.name="CircularDependencyError"}}class _ extends Error{constructor(t){super(t),this.name="CapabilityNotFoundError"}}class $ extends Error{constructor(t){super(t),this.name="CapabilityConflictError"}}class N extends Error{constructor(t){super(t),this.name="PluginInitializationError"}}class z extends Error{constructor(t){super(t),this.name="PluginConfigurationError"}}class L{constructor(t,e){this.store=t,this.pluginId=e}getState(){return this.store.getState().plugins[this.pluginId]}dispatch(t){return this.store.dispatchToPlugin(this.pluginId,t)}subscribeToState(t){return this.store.subscribeToPlugin(this.pluginId,(e,i,r)=>{t(e,i,r)})}onAction(t,e){return this.store.onAction(t,(i,r,n)=>{e(i,r.plugins[this.pluginId],n.plugins[this.pluginId])})}}const y="LOAD_DOCUMENT",w="SET_DOCUMENT",S="SET_DOCUMENT_ERROR",m="SET_SCALE",E="SET_ROTATION",b="SET_PAGES",O=[y,w,S,m,E,b],F=()=>({type:y}),I=s=>({type:w,payload:s}),k=s=>({type:S,payload:s}),q=s=>({type:m,payload:s}),U=s=>({type:E,payload:s}),j=s=>({type:b,payload:s});class G{constructor(t,e){this.initialCoreState=e,this.pluginReducers={},this.listeners=[],this.pluginListeners={},this.state={core:e,plugins:{}},this.coreReducer=t}addPluginReducer(t,e,i){this.state.plugins[t]=i,this.pluginReducers[t]=e}dispatchToCore(t){if(!this.coreReducer)return this.getState();const e=this.getState();this.state.core=this.coreReducer(this.state.core,t);const i=this.getState();return this.listeners.forEach(r=>r(t,i,e)),i}dispatchToPlugin(t,e,i=!0){const r=this.getState(),n=this.pluginReducers[t];if(!n)return r;const o=r.plugins[t],a=n(o,e);this.state.plugins[t]=a;const u=this.getState();return i&&this.listeners.forEach(c=>c(e,u,r)),this.pluginListeners[t]&&this.pluginListeners[t].forEach(c=>{c(e,a,o)}),a}dispatch(t){const e=this.getState();this.isCoreAction(t)&&(this.state.core=this.coreReducer(this.state.core,t));for(const r in this.pluginReducers){const n=this.pluginReducers[r],o=e.plugins[r];n&&(this.state.plugins[r]=n(o,t))}const i=this.getState();return this.listeners.forEach(r=>r(t,i,e)),i}getState(){return{core:{...this.state.core},plugins:{...this.state.plugins}}}subscribe(t){return this.listeners.push(t),()=>{this.listeners=this.listeners.filter(e=>e!==t)}}subscribeToPlugin(t,e){if(!(t in this.state.plugins))throw new Error(`Plugin state not found for plugin "${t}". Did you forget to call addPluginReducer?`);return this.pluginListeners[t]||(this.pluginListeners[t]=[]),this.pluginListeners[t].push(e),()=>{this.pluginListeners[t]=this.pluginListeners[t].filter(i=>i!==e),this.pluginListeners[t].length===0&&delete this.pluginListeners[t]}}onAction(t,e){return this.subscribe((i,r,n)=>{i.type===t&&e(i,r,n)})}getPluginStore(t){if(!(t in this.state.plugins))throw new Error(`Plugin state not found for plugin "${t}". Did you forget to call addPluginReducer?`);return new L(this,t)}isCoreAction(t){return O.includes(t.type)}destroy(){var t,e;this.listeners.length=0;for(const i in this.pluginListeners)(e=(t=this.pluginListeners[i])==null?void 0:t.splice)==null||e.call(t,0);this.pluginListeners={},this.pluginReducers={},this.state.plugins={},this.state.core={...this.initialCoreState}}}const D=s=>({scale:(s==null?void 0:s.scale)??1,rotation:(s==null?void 0:s.rotation)??T.Rotation.Degree0,document:null,pages:[],loading:!1,error:null}),x=s=>s.pages.map(t=>t.map(e=>({...e,rotatedSize:T.transformSize(e.size,s.rotation,1)}))),K=(s,t)=>{switch(t.type){case y:return{...s,loading:!0,error:null};case w:return{...s,document:t.payload,pages:t.payload.pages.map(e=>[e]),loading:!1,error:null};case E:return{...s,rotation:t.payload};case b:return{...s,pages:t.payload};case S:return{...s,loading:!1,error:t.payload};case m:return{...s,scale:t.payload};default:return s}};class B{constructor(t,e){this.plugins=new Map,this.manifests=new Map,this.capabilities=new Map,this.status=new Map,this.configurations=new Map,this.engineInitialized=!1,this.initPromise=null,this.pendingRegistrations=[],this.processingRegistrations=[],this.initialized=!1,this.isInitializing=!1,this.pluginsReadyPromise=null,this.destroyed=!1,this.resolver=new R,this.engine=t,this.initialCoreState=D(e),this.store=new G(K,this.initialCoreState)}async ensureEngineInitialized(){this.engineInitialized||(this.engine.initialize?(await this.engine.initialize().toPromise(),this.engineInitialized=!0):this.engineInitialized=!0)}registerPlugin(t,e){if(this.initialized&&!this.isInitializing)throw new l("Cannot register plugins after initialization");this.validateManifest(t.manifest),this.store.addPluginReducer(t.manifest.id,t.reducer,typeof t.initialState=="function"?t.initialState(this.initialCoreState,{...t.manifest.defaultConfig,...e}):t.initialState),this.pendingRegistrations.push({package:t,config:e})}getStore(){return this.store}getEngine(){return this.engine}pluginsReady(){return this.pluginsReadyPromise?this.pluginsReadyPromise:(this.pluginsReadyPromise=(async()=>{this.initialized||await this.initialize();const t=Array.from(this.plugins.values()).map(e=>typeof e.ready=="function"?e.ready():Promise.resolve());await Promise.all(t)})(),this.pluginsReadyPromise)}async initialize(){if(this.destroyed)throw new l("Registry has been destroyed");return this.initPromise?this.initPromise:(this.initPromise=(async()=>{var t;if(this.initialized)throw new l("Registry is already initialized");this.isInitializing=!0;try{if(await this.ensureEngineInitialized(),this.destroyed)return;for(;this.pendingRegistrations.length>0;){if(this.destroyed)return;this.processingRegistrations=[...this.pendingRegistrations],this.pendingRegistrations=[];for(const i of this.processingRegistrations){const r=new Set,n=[...i.package.manifest.requires,...i.package.manifest.optional];for(const o of n){const a=this.processingRegistrations.find(u=>u.package.manifest.provides.includes(o));a&&r.add(a.package.manifest.id)}this.resolver.addNode(i.package.manifest.id,[...r])}const e=this.resolver.resolveLoadOrder();for(const i of e){const r=this.processingRegistrations.find(n=>n.package.manifest.id===i);await this.initializePlugin(r.package.manifest,r.package.create,r.config)}this.processingRegistrations=[],this.resolver=new R}for(const e of this.plugins.values())await((t=e.postInitialize)==null?void 0:t.call(e).catch(i=>{console.error(`Error in postInitialize for plugin ${e.id}`,i),this.status.set(e.id,"error")}));this.initialized=!0}catch(e){throw e instanceof Error?new A(`Failed to resolve plugin dependencies: ${e.message}`):e}finally{this.isInitializing=!1}})(),this.initPromise)}async initializePlugin(t,e,i){const r={...t.defaultConfig,...i};this.validateConfig(t.id,r,t.defaultConfig);const n=e(this,this.engine,r);this.validatePlugin(n);for(const o of t.requires)if(!this.capabilities.has(o))throw new l(`Missing required capability: ${o} for plugin ${t.id}`);for(const o of t.optional)this.capabilities.has(o)&&console.debug(`Optional capability ${o} is available for plugin ${t.id}`);console.log("initializePlugin",t.id,t.provides);for(const o of t.provides){if(this.capabilities.has(o))throw new l(`Capability ${o} is already provided by plugin ${this.capabilities.get(o)}`);this.capabilities.set(o,t.id)}this.plugins.set(t.id,n),this.manifests.set(t.id,t),this.status.set(t.id,"registered"),this.configurations.set(t.id,r);try{n.initialize&&await n.initialize(r),this.status.set(t.id,"active")}catch(o){throw this.plugins.delete(t.id),this.manifests.delete(t.id),console.log("initializePlugin failed",t.id,t.provides),t.provides.forEach(a=>this.capabilities.delete(a)),o}}getPluginConfig(t){const e=this.configurations.get(t);if(!e)throw new d(`Configuration for plugin ${t} not found`);return e}validateConfig(t,e,i){const n=Object.keys(i).filter(o=>!e.hasOwnProperty(o));if(n.length>0)throw new z(`Missing required configuration keys for plugin ${t}: ${n.join(", ")}`)}async updatePluginConfig(t,e){const i=this.getPlugin(t);if(!i)throw new d(`Plugin ${t} not found`);const r=this.manifests.get(t),n=this.configurations.get(t);if(!r||!n)throw new d(`Plugin ${t} not found`);const o={...n,...e};this.validateConfig(t,o,r.defaultConfig),this.configurations.set(t,o),i.initialize&&await i.initialize(o)}registerPluginBatch(t){for(const e of t)this.registerPlugin(e.package,e.config)}async unregisterPlugin(t){const e=this.plugins.get(t);if(!e)throw new d(`Plugin ${t} is not registered`);const i=this.manifests.get(t);if(!i)throw new d(`Manifest for plugin ${t} not found`);for(const[r,n]of this.manifests.entries()){if(r===t)continue;if([...n.requires,...n.optional].some(a=>i.provides.includes(a)))throw new l(`Cannot unregister plugin ${t}: plugin ${r} depends on it`)}try{e.destroy&&await e.destroy();for(const r of i.provides)this.capabilities.delete(r);this.plugins.delete(t),this.manifests.delete(t),this.status.delete(t)}catch(r){throw r instanceof Error?new Error(`Failed to unregister plugin ${t}: ${r.message}`):r}}getPlugin(t){const e=this.plugins.get(t);return e||null}getCapabilityProvider(t){const e=this.capabilities.get(t);return e?this.getPlugin(e):null}hasCapability(t){return this.capabilities.has(t)}getAllPlugins(){return Array.from(this.plugins.values())}getPluginStatus(t){const e=this.status.get(t);if(!e)throw new d(`Plugin ${t} not found`);return e}validatePlugin(t){if(!t.id)throw new l("Plugin must have an id")}validateManifest(t){if(!t.id)throw new l("Manifest must have an id");if(!t.name)throw new l("Manifest must have a name");if(!t.version)throw new l("Manifest must have a version");if(!Array.isArray(t.provides))throw new l("Manifest must have a provides array");if(!Array.isArray(t.requires))throw new l("Manifest must have a requires array");if(!Array.isArray(t.optional))throw new l("Manifest must have an optional array")}isDestroyed(){return this.destroyed}async destroy(){var t;if(this.destroyed)throw new l("Registry has already been destroyed");this.destroyed=!0;try{await this.initPromise}catch{}for(const e of Array.from(this.plugins.values()).reverse())await((t=e.destroy)==null?void 0:t.call(e));this.store.destroy(),this.plugins.clear(),this.manifests.clear(),this.capabilities.clear(),this.status.clear(),this.pendingRegistrations.length=0,this.processingRegistrations.length=0}}function W(s,t){return{package:s,config:t}}class Y{constructor(t,e){if(this.id=t,this.registry=e,this.debouncedActions={},this.unsubscribeFromState=null,this.unsubscribeFromCoreStore=null,t!==this.constructor.id)throw new Error(`Plugin ID mismatch: ${t} !== ${this.constructor.id}`);this.coreStore=this.registry.getStore(),this.pluginStore=this.coreStore.getPluginStore(this.id),this.unsubscribeFromState=this.pluginStore.subscribeToState((i,r,n)=>{this.onStoreUpdated(n,r)}),this.unsubscribeFromCoreStore=this.coreStore.subscribe((i,r,n)=>{this.onCoreStoreUpdated(n,r)}),this.readyPromise=new Promise(i=>{this.readyResolve=i}),this.readyResolve()}provides(){if(!this._capability){const t=this.buildCapability();this._capability=Object.freeze(t)}return this._capability}get state(){return this.pluginStore.getState()}get coreState(){return this.coreStore.getState()}getState(){return this.pluginStore.getState()}getCoreState(){return this.coreStore.getState()}dispatchCoreAction(t){return this.coreStore.dispatchToCore(t)}dispatchToAllPlugins(t){return this.coreStore.dispatch(t)}dispatch(t){return this.pluginStore.dispatch(t)}debouncedDispatch(t,e=100){const i=Date.now(),r=this.debouncedActions[t.type]||0;return i-r>=e?(this.debouncedActions[t.type]=i,this.dispatch(t),!0):!1}subscribe(t){return this.pluginStore.subscribeToState(t)}subscribeToCoreStore(t){return this.coreStore.subscribe(t)}onStoreUpdated(t,e){}onCoreStoreUpdated(t,e){}destroy(){this.unsubscribeFromState&&(this.unsubscribeFromState(),this.unsubscribeFromState=null),this.unsubscribeFromCoreStore&&(this.unsubscribeFromCoreStore(),this.unsubscribeFromCoreStore=null)}ready(){return this.readyPromise}markReady(){this.readyResolve()}resetReady(){this.readyPromise=new Promise(t=>{this.readyResolve=t})}}class M{constructor(t,e){this.handler=t,this.options=e,this.lastRun=0,this.handle=i=>{this.options.mode==="debounce"?this.debounce(i):this.throttle(i)}}debounce(t){this.timeoutId&&window.clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout(()=>{this.handler(t),this.timeoutId=void 0},this.options.wait)}throttle(t){if(this.options.mode==="debounce")return;const e=Date.now(),i=this.options.throttleMode||"leading-trailing";e-this.lastRun>=this.options.wait&&(i==="leading-trailing"&&this.handler(t),this.lastRun=e),this.timeoutId&&window.clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout(()=>{this.handler(t),this.lastRun=Date.now(),this.timeoutId=void 0},this.options.wait-(e-this.lastRun))}destroy(){this.timeoutId&&window.clearTimeout(this.timeoutId)}}function H(s,t,e){return s<t?t:s>e?e:s}function p(s,t,e){if(s===t)return!0;if(s==null||t==null)return s===t;const i=typeof s;if(i!==typeof t)return!1;if(i==="object"){e||(e=new Set);const n=J(s,t);if(e.has(n))return!0;e.add(n);const o=Array.isArray(s),a=Array.isArray(t);return o&&a?V(s,t,e):!o&&!a?X(s,t,e):!1}return!1}function J(s,t){return`${v(s)}__${v(t)}`}let Q=0;const C=new WeakMap;function v(s){return C.has(s)||C.set(s,++Q),C.get(s)}function V(s,t,e){if(s.length!==t.length)return!1;const i=new Array(t.length).fill(!1);t:for(let r=0;r<s.length;r++){const n=s[r];for(let o=0;o<t.length;o++)if(!i[o]&&p(n,t[o],e)){i[o]=!0;continue t}return!1}return!0}function X(s,t,e){const i=Object.keys(s).sort(),r=Object.keys(t).sort();if(i.length!==r.length)return!1;for(let n=0;n<i.length;n++)if(i[n]!==r[n])return!1;for(const n of i){const o=s[n],a=t[n];if(!p(o,a,e))return!1}return!0}function Z(){const s=new Set;return{emit:(e=void 0)=>s.forEach(i=>i(e)),on:e=>(s.add(e),()=>s.delete(e)),off:e=>s.delete(e),clear:()=>s.clear()}}function tt(s,t=p){const e=new Set,i=new Map;let r=s;const n=a=>e.forEach(u=>u(a)),o=(a,u)=>{let c=a,g=()=>{};if(u){const h=new M(a,u);c=h.handle,g=()=>h.destroy(),i.set(a,{wrapped:c,destroy:g})}return r!==void 0&&c(r),e.add(c),()=>{e.delete(c),g(),i.delete(a)}};return{get value(){return r},emit(a=void 0){(r===void 0||!t(r,a))&&(r=a,n(a))},on:o,off(a){const u=i.get(a);u?(e.delete(u.wrapped),u.destroy(),i.delete(a)):e.delete(a)},clear(){e.clear(),i.forEach(a=>a.destroy()),i.clear()},select(a,u=p){return(c,g)=>{let h;if(r!==void 0){const f=a(r);h=f,c(f)}return o(f=>{const P=a(f);(h===void 0||!u(h,P))&&(h=P,c(P))},g)}}}}function et(s){return Object.entries(s).map(([t,e])=>{const i=Number(t);return[Number.isFinite(i)&&t.trim()!==""?i:t,e]})}exports.BasePlugin=Y;exports.CORE_ACTION_TYPES=O;exports.CapabilityConflictError=$;exports.CapabilityNotFoundError=_;exports.CircularDependencyError=A;exports.DependencyResolver=R;exports.EventControl=M;exports.LOAD_DOCUMENT=y;exports.PluginConfigurationError=z;exports.PluginInitializationError=N;exports.PluginNotFoundError=d;exports.PluginRegistrationError=l;exports.PluginRegistry=B;exports.SET_DOCUMENT=w;exports.SET_DOCUMENT_ERROR=S;exports.SET_PAGES=b;exports.SET_ROTATION=E;exports.SET_SCALE=m;exports.arePropsEqual=p;exports.clamp=H;exports.createBehaviorEmitter=tt;exports.createEmitter=Z;exports.createPluginRegistration=W;exports.enumEntries=et;exports.getPagesWithRotatedSize=x;exports.initialCoreState=D;exports.loadDocument=F;exports.setDocument=I;exports.setDocumentError=k;exports.setPages=j;exports.setRotation=U;exports.setScale=q;
//# sourceMappingURL=index.cjs.map
