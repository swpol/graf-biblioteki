"use strict";class P{constructor(){this.dependencyGraph=new Map}addNode(e,t=[]){this.dependencyGraph.set(e,new Set(t))}hasCircularDependencies(){const e=new Set,t=new Set,r=s=>{e.add(s),t.add(s);const n=this.dependencyGraph.get(s)||new Set;for(const o of n)if(e.has(o)){if(t.has(o))return!0}else if(r(o))return!0;return t.delete(s),!1};for(const s of this.dependencyGraph.keys())if(!e.has(s)&&r(s))return!0;return!1}resolveLoadOrder(){if(this.hasCircularDependencies())throw new Error("Circular dependencies detected");const e=[],t=new Set,r=new Set,s=n=>{if(r.has(n))throw new Error("Circular dependency");if(t.has(n))return;r.add(n);const o=this.dependencyGraph.get(n)||new Set;for(const a of o)s(a);r.delete(n),t.add(n),e.push(n)};for(const n of this.dependencyGraph.keys())t.has(n)||s(n);return e}}class l extends Error{constructor(e){super(e),this.name="PluginRegistrationError"}}class u extends Error{constructor(e){super(e),this.name="PluginNotFoundError"}}class v extends Error{constructor(e){super(e),this.name="CircularDependencyError"}}class D extends Error{constructor(e){super(e),this.name="CapabilityNotFoundError"}}class A extends Error{constructor(e){super(e),this.name="CapabilityConflictError"}}class z extends Error{constructor(e){super(e),this.name="PluginInitializationError"}}class R extends Error{constructor(e){super(e),this.name="PluginConfigurationError"}}class M{constructor(e,t){this.store=e,this.pluginId=t}getState(){return this.store.getState().plugins[this.pluginId]}dispatch(e){return this.store.dispatchToPlugin(this.pluginId,e)}subscribeToState(e){return this.store.subscribeToPlugin(this.pluginId,(t,r,s)=>{e(t,r,s)})}onAction(e,t){return this.store.onAction(e,(r,s,n)=>{t(r,s.plugins[this.pluginId],n.plugins[this.pluginId])})}}const c="LOAD_DOCUMENT",h="SET_DOCUMENT",d="SET_DOCUMENT_ERROR",g="SET_SCALE",f="SET_ROTATION",p="SET_PAGES",m=[c,h,d,g,f,p],N=()=>({type:c}),_=i=>({type:h,payload:i}),F=i=>({type:d,payload:i}),L=i=>({type:g,payload:i}),$=i=>({type:f,payload:i}),k=i=>({type:p,payload:i});class j{constructor(e,t){this.initialCoreState=t,this.pluginReducers={},this.listeners=[],this.pluginListeners={},this.state={core:t,plugins:{}},this.coreReducer=e}addPluginReducer(e,t,r){this.state.plugins[e]=r,this.pluginReducers[e]=t}dispatchToCore(e){if(!this.coreReducer)return this.getState();const t=this.getState();this.state.core=this.coreReducer(this.state.core,e);const r=this.getState();return this.listeners.forEach(s=>s(e,r,t)),r}dispatchToPlugin(e,t,r=!0){const s=this.getState(),n=this.pluginReducers[e];if(!n)return s;const o=s.plugins[e],a=n(o,t);this.state.plugins[e]=a;const y=this.getState();return r&&this.listeners.forEach(w=>w(t,y,s)),this.pluginListeners[e]&&this.pluginListeners[e].forEach(w=>{w(t,a,o)}),a}dispatch(e){const t=this.getState();this.isCoreAction(e)&&(this.state.core=this.coreReducer(this.state.core,e));for(const s in this.pluginReducers){const n=this.pluginReducers[s],o=t.plugins[s];n&&(this.state.plugins[s]=n(o,e))}const r=this.getState();return this.listeners.forEach(s=>s(e,r,t)),r}getState(){return{core:{...this.state.core},plugins:{...this.state.plugins}}}subscribe(e){return this.listeners.push(e),()=>{this.listeners=this.listeners.filter(t=>t!==e)}}subscribeToPlugin(e,t){if(!(e in this.state.plugins))throw new Error(`Plugin state not found for plugin "${e}". Did you forget to call addPluginReducer?`);return this.pluginListeners[e]||(this.pluginListeners[e]=[]),this.pluginListeners[e].push(t),()=>{this.pluginListeners[e]=this.pluginListeners[e].filter(r=>r!==t),this.pluginListeners[e].length===0&&delete this.pluginListeners[e]}}onAction(e,t){return this.subscribe((r,s,n)=>{r.type===e&&t(r,s,n)})}getPluginStore(e){if(!(e in this.state.plugins))throw new Error(`Plugin state not found for plugin "${e}". Did you forget to call addPluginReducer?`);return new M(this,e)}isCoreAction(e){return m.includes(e.type)}destroy(){var e,t;this.listeners.length=0;for(const r in this.pluginListeners)(t=(e=this.pluginListeners[r])==null?void 0:e.splice)==null||t.call(e,0);this.pluginListeners={},this.pluginReducers={},this.state.plugins={},this.state.core={...this.initialCoreState}}}var T=(i=>(i[i.Degree0=0]="Degree0",i[i.Degree90=1]="Degree90",i[i.Degree180=2]="Degree180",i[i.Degree270=3]="Degree270",i))(T||{});function q(i){const{width:e,height:t}=i;return{width:t,height:e}}function x(i,e,t){return i=e%2===0?i:q(i),{width:i.width*t,height:i.height*t}}var G="­",U="​",B="⁠",I="\uFEFF",K="￾",H="￿",W=Object.freeze([G,U,B,I,K,H]);new RegExp(`[${W.join("")}]`,"g");var S=Object.freeze([{id:0,label:"Normal",css:"normal"},{id:1,label:"Multiply",css:"multiply"},{id:2,label:"Screen",css:"screen"},{id:3,label:"Overlay",css:"overlay"},{id:4,label:"Darken",css:"darken"},{id:5,label:"Lighten",css:"lighten"},{id:6,label:"Color Dodge",css:"color-dodge"},{id:7,label:"Color Burn",css:"color-burn"},{id:8,label:"Hard Light",css:"hard-light"},{id:9,label:"Soft Light",css:"soft-light"},{id:10,label:"Difference",css:"difference"},{id:11,label:"Exclusion",css:"exclusion"},{id:12,label:"Hue",css:"hue"},{id:13,label:"Saturation",css:"saturation"},{id:14,label:"Color",css:"color"},{id:15,label:"Luminosity",css:"luminosity"}]);S.reduce((i,e)=>(i[e.id]=e,i),{});S.reduce((i,e)=>(i[e.css]=e.id,i),{});S.map(i=>({value:i.id,label:i.label}));var Z=Object.freeze({1:"invisible",2:"hidden",4:"print",8:"noZoom",16:"noRotate",32:"noView",64:"readOnly",128:"locked",256:"toggleNoView"});Object.entries(Z).reduce((i,[e,t])=>(i[t]=Number(e),i),{});const O=i=>({scale:(i==null?void 0:i.scale)??1,rotation:(i==null?void 0:i.rotation)??T.Degree0,document:null,pages:[],loading:!1,error:null}),V=(i,e)=>{switch(e.type){case c:return{...i,loading:!0,error:null};case h:return{...i,document:e.payload,pages:e.payload.pages.map(t=>[t]),loading:!1,error:null};case f:return{...i,rotation:e.payload};case p:return{...i,pages:e.payload};case d:return{...i,loading:!1,error:e.payload};case g:return{...i,scale:e.payload};default:return i}};class Y{constructor(e,t){this.plugins=new Map,this.manifests=new Map,this.capabilities=new Map,this.status=new Map,this.configurations=new Map,this.engineInitialized=!1,this.initPromise=null,this.pendingRegistrations=[],this.processingRegistrations=[],this.initialized=!1,this.isInitializing=!1,this.pluginsReadyPromise=null,this.destroyed=!1,this.resolver=new P,this.engine=e,this.initialCoreState=O(t),this.store=new j(V,this.initialCoreState)}async ensureEngineInitialized(){this.engineInitialized||(this.engine.initialize?(await this.engine.initialize().toPromise(),this.engineInitialized=!0):this.engineInitialized=!0)}registerPlugin(e,t){if(this.initialized&&!this.isInitializing)throw new l("Cannot register plugins after initialization");this.validateManifest(e.manifest),this.store.addPluginReducer(e.manifest.id,e.reducer,typeof e.initialState=="function"?e.initialState(this.initialCoreState,{...e.manifest.defaultConfig,...t}):e.initialState),this.pendingRegistrations.push({package:e,config:t})}getStore(){return this.store}getEngine(){return this.engine}pluginsReady(){return this.pluginsReadyPromise?this.pluginsReadyPromise:(this.pluginsReadyPromise=(async()=>{this.initialized||await this.initialize();const e=Array.from(this.plugins.values()).map(t=>typeof t.ready=="function"?t.ready():Promise.resolve());await Promise.all(e)})(),this.pluginsReadyPromise)}async initialize(){if(this.destroyed)throw new l("Registry has been destroyed");return this.initPromise?this.initPromise:(this.initPromise=(async()=>{var e;if(this.initialized)throw new l("Registry is already initialized");this.isInitializing=!0;try{if(await this.ensureEngineInitialized(),this.destroyed)return;for(;this.pendingRegistrations.length>0;){if(this.destroyed)return;this.processingRegistrations=[...this.pendingRegistrations],this.pendingRegistrations=[];for(const r of this.processingRegistrations){const s=new Set,n=[...r.package.manifest.requires,...r.package.manifest.optional];for(const o of n){const a=this.processingRegistrations.find(y=>y.package.manifest.provides.includes(o));a&&s.add(a.package.manifest.id)}this.resolver.addNode(r.package.manifest.id,[...s])}const t=this.resolver.resolveLoadOrder();for(const r of t){const s=this.processingRegistrations.find(n=>n.package.manifest.id===r);await this.initializePlugin(s.package.manifest,s.package.create,s.config)}this.processingRegistrations=[],this.resolver=new P}for(const t of this.plugins.values())await((e=t.postInitialize)==null?void 0:e.call(t).catch(r=>{console.error(`Error in postInitialize for plugin ${t.id}`,r),this.status.set(t.id,"error")}));this.initialized=!0}catch(t){throw t instanceof Error?new v(`Failed to resolve plugin dependencies: ${t.message}`):t}finally{this.isInitializing=!1}})(),this.initPromise)}async initializePlugin(e,t,r){const s={...e.defaultConfig,...r};this.validateConfig(e.id,s,e.defaultConfig);const n=t(this,this.engine,s);this.validatePlugin(n);for(const o of e.requires)if(!this.capabilities.has(o))throw new l(`Missing required capability: ${o} for plugin ${e.id}`);for(const o of e.optional)this.capabilities.has(o)&&console.debug(`Optional capability ${o} is available for plugin ${e.id}`);console.log("initializePlugin",e.id,e.provides);for(const o of e.provides){if(this.capabilities.has(o))throw new l(`Capability ${o} is already provided by plugin ${this.capabilities.get(o)}`);this.capabilities.set(o,e.id)}this.plugins.set(e.id,n),this.manifests.set(e.id,e),this.status.set(e.id,"registered"),this.configurations.set(e.id,s);try{n.initialize&&await n.initialize(s),this.status.set(e.id,"active")}catch(o){throw this.plugins.delete(e.id),this.manifests.delete(e.id),console.log("initializePlugin failed",e.id,e.provides),e.provides.forEach(a=>this.capabilities.delete(a)),o}}getPluginConfig(e){const t=this.configurations.get(e);if(!t)throw new u(`Configuration for plugin ${e} not found`);return t}validateConfig(e,t,r){const n=Object.keys(r).filter(o=>!t.hasOwnProperty(o));if(n.length>0)throw new R(`Missing required configuration keys for plugin ${e}: ${n.join(", ")}`)}async updatePluginConfig(e,t){const r=this.getPlugin(e);if(!r)throw new u(`Plugin ${e} not found`);const s=this.manifests.get(e),n=this.configurations.get(e);if(!s||!n)throw new u(`Plugin ${e} not found`);const o={...n,...t};this.validateConfig(e,o,s.defaultConfig),this.configurations.set(e,o),r.initialize&&await r.initialize(o)}registerPluginBatch(e){for(const t of e)this.registerPlugin(t.package,t.config)}async unregisterPlugin(e){const t=this.plugins.get(e);if(!t)throw new u(`Plugin ${e} is not registered`);const r=this.manifests.get(e);if(!r)throw new u(`Manifest for plugin ${e} not found`);for(const[s,n]of this.manifests.entries()){if(s===e)continue;if([...n.requires,...n.optional].some(a=>r.provides.includes(a)))throw new l(`Cannot unregister plugin ${e}: plugin ${s} depends on it`)}try{t.destroy&&await t.destroy();for(const s of r.provides)this.capabilities.delete(s);this.plugins.delete(e),this.manifests.delete(e),this.status.delete(e)}catch(s){throw s instanceof Error?new Error(`Failed to unregister plugin ${e}: ${s.message}`):s}}getPlugin(e){const t=this.plugins.get(e);return t||null}getCapabilityProvider(e){const t=this.capabilities.get(e);return t?this.getPlugin(t):null}hasCapability(e){return this.capabilities.has(e)}getAllPlugins(){return Array.from(this.plugins.values())}getPluginStatus(e){const t=this.status.get(e);if(!t)throw new u(`Plugin ${e} not found`);return t}validatePlugin(e){if(!e.id)throw new l("Plugin must have an id")}validateManifest(e){if(!e.id)throw new l("Manifest must have an id");if(!e.name)throw new l("Manifest must have a name");if(!e.version)throw new l("Manifest must have a version");if(!Array.isArray(e.provides))throw new l("Manifest must have a provides array");if(!Array.isArray(e.requires))throw new l("Manifest must have a requires array");if(!Array.isArray(e.optional))throw new l("Manifest must have an optional array")}isDestroyed(){return this.destroyed}async destroy(){var e;if(this.destroyed)throw new l("Registry has already been destroyed");this.destroyed=!0;try{await this.initPromise}catch{}for(const t of Array.from(this.plugins.values()).reverse())await((e=t.destroy)==null?void 0:e.call(t));this.store.destroy(),this.plugins.clear(),this.manifests.clear(),this.capabilities.clear(),this.status.clear(),this.pendingRegistrations.length=0,this.processingRegistrations.length=0}}function J(i,e,t){return i<e?e:i>t?t:i}function b(i,e,t){if(i===e)return!0;if(i==null||e==null)return i===e;const r=typeof i;if(r!==typeof e)return!1;if(r==="object"){t||(t=new Set);const n=Q(i,e);if(t.has(n))return!0;t.add(n);const o=Array.isArray(i),a=Array.isArray(e);return o&&a?ee(i,e,t):!o&&!a?te(i,e,t):!1}return!1}function Q(i,e){return`${C(i)}__${C(e)}`}let X=0;const E=new WeakMap;function C(i){return E.has(i)||E.set(i,++X),E.get(i)}function ee(i,e,t){if(i.length!==e.length)return!1;const r=new Array(e.length).fill(!1);e:for(let s=0;s<i.length;s++){const n=i[s];for(let o=0;o<e.length;o++)if(!r[o]&&b(n,e[o],t)){r[o]=!0;continue e}return!1}return!0}function te(i,e,t){const r=Object.keys(i).sort(),s=Object.keys(e).sort();if(r.length!==s.length)return!1;for(let n=0;n<r.length;n++)if(r[n]!==s[n])return!1;for(const n of r){const o=i[n],a=e[n];if(!b(o,a,t))return!1}return!0}exports.CORE_ACTION_TYPES=m;exports.CapabilityConflictError=A;exports.CapabilityNotFoundError=D;exports.CircularDependencyError=v;exports.DependencyResolver=P;exports.LOAD_DOCUMENT=c;exports.PluginConfigurationError=R;exports.PluginInitializationError=z;exports.PluginNotFoundError=u;exports.PluginRegistrationError=l;exports.PluginRegistry=Y;exports.SET_DOCUMENT=h;exports.SET_DOCUMENT_ERROR=d;exports.SET_PAGES=p;exports.SET_ROTATION=f;exports.SET_SCALE=g;exports.arePropsEqual=b;exports.clamp=J;exports.initialCoreState=O;exports.loadDocument=N;exports.setDocument=_;exports.setDocumentError=F;exports.setPages=k;exports.setRotation=$;exports.setScale=L;exports.transformSize=x;
//# sourceMappingURL=math-BJ_3g2sS.cjs.map
