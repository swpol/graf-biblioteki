/**
 * Bundled by jsDelivr using Rollup v2.79.2 and Terser v5.39.0.
 * Original file: /npm/@embedpdf/plugin-tiling@1.0.7/dist/index.js
 *
 * Do NOT use SRI with dynamically generated files! More information: https://www.jsdelivr.com/using-sri-with-dynamic-files
 */
import{BasePlugin as e,createBehaviorEmitter as i}from"/npm/@embedpdf/core@1.0.7/+esm";import{ignore as t}from"/npm/@embedpdf/models@1.0.7/+esm";var s="tiling",a={id:s,name:"Tiling Plugin",version:"1.0.0",provides:["tiling"],requires:["render","scroll","viewport"],optional:[],defaultConfig:{enabled:!0,tileSize:768,overlapPx:2.5,extraRings:0}},l="UPDATE_VISIBLE_TILES",r="MARK_TILE_STATUS",n=e=>({type:l,payload:e}),o=(e,i,t)=>({type:r,payload:{pageIndex:e,tileId:i,status:t}});function c({tileSize:e=768,overlapPx:i=2.5,extraRings:t=0,scale:s,page:a,metric:l}){const r=a.size.width*s,n=a.size.height*s,o=e-i,c=l.scaled.pageX,d=l.scaled.pageY,p=c+l.scaled.visibleWidth,h=d+l.scaled.visibleHeight,g=Math.floor((r-1)/o),b=Math.floor((n-1)/o),u=Math.max(0,Math.floor(c/o)-t),f=Math.min(g,Math.floor((p-1)/o)+t),m=Math.max(0,Math.floor(d/o)-t),v=Math.min(b,Math.floor((h-1)/o)+t),y=[];for(let i=u;i<=f;i++){const t=i*o,l=Math.min(e,r-t),c=t/s,d=l/s;for(let r=m;r<=v;r++){const p=r*o,h=Math.min(e,n-p),g=p/s,b=h/s;y.push({id:`p${a.index}-${s}-x${t}-y${p}-w${l}-h${h}`,col:i,row:r,pageRect:{origin:{x:c,y:g},size:{width:d,height:b}},screenRect:{origin:{x:t,y:p},size:{width:l,height:h}},status:"queued",srcScale:s,isFallback:!1})}}return y}var d=class extends e{constructor(e,t,s){super(e,t),this.tileRendering$=i(),this.config=s,this.renderCapability=this.registry.getPlugin("render").provides(),this.scrollCapability=this.registry.getPlugin("scroll").provides(),this.viewportCapability=this.registry.getPlugin("viewport").provides(),this.scrollCapability.onScroll((e=>this.calculateVisibleTiles(e)),{mode:"throttle",wait:500,throttleMode:"trailing"})}async initialize(){}onCoreStoreUpdated(e,i){e.core.scale!==i.core.scale&&this.calculateVisibleTiles(this.scrollCapability.getMetrics(this.viewportCapability.getMetrics()))}calculateVisibleTiles(e){if(!this.config.enabled)return void this.dispatch(n([]));const i=this.coreState.core.scale,t={};for(const s of e.pageVisibilityMetrics){const e=s.pageNumber-1,a=this.coreState.core.document?.pages[e];if(!a)continue;const l=c({page:a,metric:s,scale:i,tileSize:this.config.tileSize,overlapPx:this.config.overlapPx,extraRings:this.config.extraRings});t[e]=l}this.dispatch(n(t))}onStoreUpdated(e,i){this.tileRendering$.emit(i.visibleTiles)}buildCapability(){return{renderTile:this.renderTile.bind(this),onTileRendering:this.tileRendering$.on}}renderTile(e){if(!this.renderCapability)throw new Error("Render capability not available.");this.dispatch(o(e.pageIndex,e.tile.id,"rendering"));const i=this.renderCapability.renderPageRect({pageIndex:e.pageIndex,rect:e.tile.pageRect,scaleFactor:e.tile.srcScale,dpr:e.dpr});return i.wait((()=>{this.dispatch(o(e.pageIndex,e.tile.id,"ready"))}),t),i}};d.id="tiling";var p={manifest:a,create:(e,i,t)=>new d(s,e,t),reducer:(e,i)=>((e,i)=>{switch(i.type){case l:{const t=i.payload,s={...e.visibleTiles};for(const e in t){const i=Number(e),a=t[i],l=s[i]??[],r=l.find((e=>!e.isFallback))?.srcScale,n=a[0].srcScale;if(void 0!==r&&r!==n){const e=l.filter((e=>!e.isFallback&&"ready"===e.status)).map((e=>({...e,isFallback:!0}))),t=e.length>0?[]:l.filter((e=>e.isFallback));s[i]=[...t,...e,...a]}else{const e=new Set(a.map((e=>e.id))),t=[],r=new Set;for(const i of l)(i.isFallback||e.has(i.id))&&(t.push(i),r.add(i.id));for(const e of a)r.has(e.id)||t.push(e);s[i]=t}}return{...e,visibleTiles:s}}case r:{const{pageIndex:t,tileId:s,status:a}=i.payload,l=e.visibleTiles[t]?.map((e=>e.id===s?{...e,status:a}:e))??[],r=l.filter((e=>!e.isFallback)),n=r.every((e=>"ready"===e.status))?r:l;return{...e,visibleTiles:{...e.visibleTiles,[t]:n}}}default:return e}})(e,i),initialState:{visibleTiles:{}}};export{s as TILING_PLUGIN_ID,d as TilingPlugin,p as TilingPluginPackage,a as manifest};export default null;
//# sourceMappingURL=/sm/663e02e570df15e7def4a440f10d64396e5f0e3475046a319d0f8347350c56a2.map