"use strict";Object.defineProperty(exports,Symbol.toStringTag,{value:"Module"});const C=require("@embedpdf/core"),x=require("@embedpdf/models"),P="tiling",_={id:P,name:"Tiling Plugin",version:"1.0.0",provides:["tiling"],requires:["render","scroll","viewport"],optional:[],defaultConfig:{enabled:!0,tileSize:768,overlapPx:2.5,extraRings:0}},L="UPDATE_VISIBLE_TILES",E="MARK_TILE_STATUS",k=t=>({type:L,payload:t}),z=(t,e,i)=>({type:E,payload:{pageIndex:t,tileId:e,status:i}}),H={visibleTiles:{}},K=(t,e)=>{var i,s;switch(e.type){case L:{const a=e.payload,o={...t.visibleTiles};for(const h in a){const r=Number(h),l=a[r],n=o[r]??[],f=(i=n.find(p=>!p.isFallback))==null?void 0:i.srcScale,g=l[0].srcScale;if(f!==void 0&&f!==g){const p=n.filter(d=>!d.isFallback&&d.status==="ready").map(d=>({...d,isFallback:!0})),u=p.length>0?[]:n.filter(d=>d.isFallback);o[r]=[...u,...p,...l]}else{const p=new Set(l.map(c=>c.id)),u=[],d=new Set;for(const c of n)(c.isFallback||p.has(c.id))&&(u.push(c),d.add(c.id));for(const c of l)d.has(c.id)||u.push(c);o[r]=u}}return{...t,visibleTiles:o}}case E:{const{pageIndex:a,tileId:o,status:h}=e.payload,r=((s=t.visibleTiles[a])==null?void 0:s.map(g=>g.id===o?{...g,status:h}:g))??[],l=r.filter(g=>!g.isFallback),f=l.every(g=>g.status==="ready")?l:r;return{...t,visibleTiles:{...t.visibleTiles,[a]:f}}}default:return t}};function W({tileSize:t=768,overlapPx:e=2.5,extraRings:i=0,scale:s,rotation:a,page:o,metric:h}){const r=o.size.width*s,l=o.size.height*s,n=t-e,f=x.transformSize(o.size,a,s),g={origin:{x:h.scaled.pageX,y:h.scaled.pageY},size:{width:h.scaled.visibleWidth,height:h.scaled.visibleHeight}},b=x.restoreRect(f,g,a,1),p=b.origin.x,u=b.origin.y,d=p+b.size.width,c=u+b.size.height,F=Math.floor((r-1)/n),V=Math.floor((l-1)/n),$=Math.max(0,Math.floor(p/n)-i),U=Math.min(F,Math.floor((d-1)/n)+i),A=Math.max(0,Math.floor(u/n)-i),N=Math.min(V,Math.floor((c-1)/n)+i),M=[];for(let y=$;y<=U;y++){const T=y*n,m=Math.min(t,r-T),B=T/s,q=m/s;for(let v=A;v<=N;v++){const S=v*n,I=Math.min(t,l-S),D=S/s,G=I/s;M.push({id:`p${o.index}-${s}-x${T}-y${S}-w${m}-h${I}`,col:y,row:v,pageRect:{origin:{x:B,y:D},size:{width:q,height:G}},screenRect:{origin:{x:T,y:S},size:{width:m,height:I}},status:"queued",srcScale:s,isFallback:!1})}}return M}const R=class R extends C.BasePlugin{constructor(e,i,s){super(e,i),this.tileRendering$=C.createBehaviorEmitter(),this.config=s,this.renderCapability=this.registry.getPlugin("render").provides(),this.scrollCapability=this.registry.getPlugin("scroll").provides(),this.viewportCapability=this.registry.getPlugin("viewport").provides(),this.scrollCapability.onScroll(a=>this.calculateVisibleTiles(a),{mode:"throttle",wait:500,throttleMode:"trailing"})}async initialize(){}onCoreStoreUpdated(e,i){e.core.scale!==i.core.scale&&this.calculateVisibleTiles(this.scrollCapability.getMetrics(this.viewportCapability.getMetrics()))}calculateVisibleTiles(e){var o;if(!this.config.enabled){this.dispatch(k([]));return}const i=this.coreState.core.scale,s=this.coreState.core.rotation,a={};for(const h of e.pageVisibilityMetrics){const r=h.pageNumber-1,l=(o=this.coreState.core.document)==null?void 0:o.pages[r];if(!l)continue;const n=W({page:l,metric:h,scale:i,rotation:s,tileSize:this.config.tileSize,overlapPx:this.config.overlapPx,extraRings:this.config.extraRings});a[r]=n}this.dispatch(k(a))}onStoreUpdated(e,i){this.tileRendering$.emit(i.visibleTiles)}buildCapability(){return{renderTile:this.renderTile.bind(this),onTileRendering:this.tileRendering$.on}}renderTile(e){if(!this.renderCapability)throw new Error("Render capability not available.");this.dispatch(z(e.pageIndex,e.tile.id,"rendering"));const i=this.renderCapability.renderPageRect({pageIndex:e.pageIndex,rect:e.tile.pageRect,scaleFactor:e.tile.srcScale,dpr:e.dpr});return i.wait(()=>{this.dispatch(z(e.pageIndex,e.tile.id,"ready"))},x.ignore),i}};R.id="tiling";let w=R;const j={manifest:_,create:(t,e,i)=>new w(P,t,i),reducer:(t,e)=>K(t,e),initialState:H};exports.TILING_PLUGIN_ID=P;exports.TilingPlugin=w;exports.TilingPluginPackage=j;exports.manifest=_;
//# sourceMappingURL=index.cjs.map
