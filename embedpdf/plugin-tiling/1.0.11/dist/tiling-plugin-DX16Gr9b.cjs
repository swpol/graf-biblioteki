"use strict";const D="UPDATE_VISIBLE_TILES",O="MARK_TILE_STATUS",M=t=>({type:D,payload:t}),z=(t,e,i)=>({type:O,payload:{pageIndex:t,tileId:e,status:i}});var G="­",J="​",Y="⁠",Q="\uFEFF",P="￾",E="￿",tt=Object.freeze([G,J,Y,Q,P,E]);new RegExp(`[${tt.join("")}]`,"g");var T=Object.freeze([{id:0,label:"Normal",css:"normal"},{id:1,label:"Multiply",css:"multiply"},{id:2,label:"Screen",css:"screen"},{id:3,label:"Overlay",css:"overlay"},{id:4,label:"Darken",css:"darken"},{id:5,label:"Lighten",css:"lighten"},{id:6,label:"Color Dodge",css:"color-dodge"},{id:7,label:"Color Burn",css:"color-burn"},{id:8,label:"Hard Light",css:"hard-light"},{id:9,label:"Soft Light",css:"soft-light"},{id:10,label:"Difference",css:"difference"},{id:11,label:"Exclusion",css:"exclusion"},{id:12,label:"Hue",css:"hue"},{id:13,label:"Saturation",css:"saturation"},{id:14,label:"Color",css:"color"},{id:15,label:"Luminosity",css:"luminosity"}]);T.reduce((t,e)=>(t[e.id]=e,t),{});T.reduce((t,e)=>(t[e.css]=e.id,t),{});T.map(t=>({value:t.id,label:t.label}));var et=Object.freeze({1:"invisible",2:"hidden",4:"print",8:"noZoom",16:"noRotate",32:"noView",64:"readOnly",128:"locked",256:"toggleNoView"});Object.entries(et).reduce((t,[e,i])=>(t[i]=Number(e),t),{});function w(t,e,i){if(t===e)return!0;if(t==null||e==null)return t===e;const s=typeof t;if(s!==typeof e)return!1;if(s==="object"){i||(i=new Set);const n=it(t,e);if(i.has(n))return!0;i.add(n);const a=Array.isArray(t),l=Array.isArray(e);return a&&l?nt(t,e,i):!a&&!l?at(t,e,i):!1}return!1}function it(t,e){return`${L(t)}__${L(e)}`}let st=0;const R=new WeakMap;function L(t){return R.has(t)||R.set(t,++st),R.get(t)}function nt(t,e,i){if(t.length!==e.length)return!1;const s=new Array(e.length).fill(!1);t:for(let n=0;n<t.length;n++){const a=t[n];for(let l=0;l<e.length;l++)if(!s[l]&&w(a,e[l],i)){s[l]=!0;continue t}return!1}return!0}function at(t,e,i){const s=Object.keys(t).sort(),n=Object.keys(e).sort();if(s.length!==n.length)return!1;for(let a=0;a<s.length;a++)if(s[a]!==n[a])return!1;for(const a of s){const l=t[a],o=e[a];if(!w(l,o,i))return!1}return!0}class ot{constructor(e,i){if(this.id=e,this.registry=i,this.debouncedActions={},this.unsubscribeFromState=null,this.unsubscribeFromCoreStore=null,e!==this.constructor.id)throw new Error(`Plugin ID mismatch: ${e} !== ${this.constructor.id}`);this.coreStore=this.registry.getStore(),this.pluginStore=this.coreStore.getPluginStore(this.id),this.unsubscribeFromState=this.pluginStore.subscribeToState((s,n,a)=>{this.onStoreUpdated(a,n)}),this.unsubscribeFromCoreStore=this.coreStore.subscribe((s,n,a)=>{this.onCoreStoreUpdated(a,n)}),this.readyPromise=new Promise(s=>{this.readyResolve=s}),this.readyResolve()}provides(){if(!this._capability){const e=this.buildCapability();this._capability=Object.freeze(e)}return this._capability}get state(){return this.pluginStore.getState()}get coreState(){return this.coreStore.getState()}getState(){return this.pluginStore.getState()}getCoreState(){return this.coreStore.getState()}dispatchCoreAction(e){return this.coreStore.dispatchToCore(e)}dispatchToAllPlugins(e){return this.coreStore.dispatch(e)}dispatch(e){return this.pluginStore.dispatch(e)}debouncedDispatch(e,i=100){const s=Date.now(),n=this.debouncedActions[e.type]||0;return s-n>=i?(this.debouncedActions[e.type]=s,this.dispatch(e),!0):!1}subscribe(e){return this.pluginStore.subscribeToState(e)}subscribeToCoreStore(e){return this.coreStore.subscribe(e)}onStoreUpdated(e,i){}onCoreStoreUpdated(e,i){}destroy(){this.unsubscribeFromState&&(this.unsubscribeFromState(),this.unsubscribeFromState=null),this.unsubscribeFromCoreStore&&(this.unsubscribeFromCoreStore(),this.unsubscribeFromCoreStore=null)}ready(){return this.readyPromise}markReady(){this.readyResolve()}resetReady(){this.readyPromise=new Promise(e=>{this.readyResolve=e})}}class lt{constructor(e,i){this.handler=e,this.options=i,this.lastRun=0,this.handle=s=>{this.options.mode==="debounce"?this.debounce(s):this.throttle(s)}}debounce(e){this.timeoutId&&window.clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout(()=>{this.handler(e),this.timeoutId=void 0},this.options.wait)}throttle(e){if(this.options.mode==="debounce")return;const i=Date.now(),s=this.options.throttleMode||"leading-trailing";i-this.lastRun>=this.options.wait&&(s==="leading-trailing"&&this.handler(e),this.lastRun=i),this.timeoutId&&window.clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout(()=>{this.handler(e),this.lastRun=Date.now(),this.timeoutId=void 0},this.options.wait-(i-this.lastRun))}destroy(){this.timeoutId&&window.clearTimeout(this.timeoutId)}}function rt(t,e=w){const i=new Set,s=new Map;let n=t;const a=o=>i.forEach(c=>c(o)),l=(o,c)=>{let r=o,d=()=>{};if(c){const h=new lt(o,c);r=h.handle,d=()=>h.destroy(),s.set(o,{wrapped:r,destroy:d})}return n!==void 0&&r(n),i.add(r),()=>{i.delete(r),d(),s.delete(o)}};return{get value(){return n},emit(o=void 0){(n===void 0||!e(n,o))&&(n=o,a(o))},on:l,off(o){const c=s.get(o);c?(i.delete(c.wrapped),c.destroy(),s.delete(o)):i.delete(o)},clear(){i.clear(),s.forEach(o=>o.destroy()),s.clear()},select(o,c=w){return(r,d)=>{let h;if(n!==void 0){const u=o(n);h=u,r(u)}return l(u=>{const g=o(u);(h===void 0||!c(h,g))&&(h=g,r(g))},d)}}}}function F(t){const{width:e,height:i}=t;return{width:i,height:e}}function ct(t,e,i){return t=e%2===0?t:F(t),{width:t.width*i,height:t.height*i}}function ht(t,e,i){let s=e.origin.x,n=e.origin.y,a=e.size;switch(i){case 0:break;case 1:s=t.height-e.origin.y-e.size.height,n=e.origin.x,a=F(e.size);break;case 2:s=t.width-e.origin.x-e.size.width,n=t.height-e.origin.y-e.size.height;break;case 3:s=e.origin.y,n=t.width-e.origin.x-e.size.width,a=F(e.size);break}return{origin:{x:s,y:n},size:{width:a.width,height:a.height}}}function ut(t,e){return{origin:{x:t.origin.x*e,y:t.origin.y*e},size:{width:t.size.width*e,height:t.size.height*e}}}function dt(t,e,i,s){return ut(ht(t,e,(4-i)%4),1/s)}var gt="­",bt="​",pt="⁠",St="\uFEFF",yt="￾",wt="￿",mt=Object.freeze([gt,bt,pt,St,yt,wt]);new RegExp(`[${mt.join("")}]`,"g");var A=Object.freeze([{id:0,label:"Normal",css:"normal"},{id:1,label:"Multiply",css:"multiply"},{id:2,label:"Screen",css:"screen"},{id:3,label:"Overlay",css:"overlay"},{id:4,label:"Darken",css:"darken"},{id:5,label:"Lighten",css:"lighten"},{id:6,label:"Color Dodge",css:"color-dodge"},{id:7,label:"Color Burn",css:"color-burn"},{id:8,label:"Hard Light",css:"hard-light"},{id:9,label:"Soft Light",css:"soft-light"},{id:10,label:"Difference",css:"difference"},{id:11,label:"Exclusion",css:"exclusion"},{id:12,label:"Hue",css:"hue"},{id:13,label:"Saturation",css:"saturation"},{id:14,label:"Color",css:"color"},{id:15,label:"Luminosity",css:"luminosity"}]);A.reduce((t,e)=>(t[e.id]=e,t),{});A.reduce((t,e)=>(t[e.css]=e.id,t),{});A.map(t=>({value:t.id,label:t.label}));var vt=Object.freeze({1:"invisible",2:"hidden",4:"print",8:"noZoom",16:"noRotate",32:"noView",64:"readOnly",128:"locked",256:"toggleNoView"});Object.entries(vt).reduce((t,[e,i])=>(t[i]=Number(e),t),{});var N=(t=>(t[t.Ok=0]="Ok",t[t.Unknown=1]="Unknown",t[t.NotFound=2]="NotFound",t[t.WrongFormat=3]="WrongFormat",t[t.Password=4]="Password",t[t.Security=5]="Security",t[t.PageError=6]="PageError",t[t.XFALoad=7]="XFALoad",t[t.XFALayout=8]="XFALayout",t[t.Cancelled=9]="Cancelled",t[t.Initialization=10]="Initialization",t[t.NotReady=11]="NotReady",t[t.NotSupport=12]="NotSupport",t[t.LoadDoc=13]="LoadDoc",t[t.DocNotOpen=14]="DocNotOpen",t[t.CantCloseDoc=15]="CantCloseDoc",t[t.CantCreateNewDoc=16]="CantCreateNewDoc",t[t.CantImportPages=17]="CantImportPages",t[t.CantCreateAnnot=18]="CantCreateAnnot",t[t.CantSetAnnotRect=19]="CantSetAnnotRect",t[t.CantSetAnnotContent=20]="CantSetAnnotContent",t[t.CantRemoveInkList=21]="CantRemoveInkList",t[t.CantAddInkStoke=22]="CantAddInkStoke",t[t.CantReadAttachmentSize=23]="CantReadAttachmentSize",t[t.CantReadAttachmentContent=24]="CantReadAttachmentContent",t[t.CantFocusAnnot=25]="CantFocusAnnot",t[t.CantSelectText=26]="CantSelectText",t[t.CantSelectOption=27]="CantSelectOption",t[t.CantCheckField=28]="CantCheckField",t))(N||{});function C(){}function Rt({tileSize:t=768,overlapPx:e=2.5,extraRings:i=0,scale:s,rotation:n,page:a,metric:l}){const o=a.size.width*s,c=a.size.height*s,r=t-e,d=ct(a.size,n,s),h={origin:{x:l.scaled.pageX,y:l.scaled.pageY},size:{width:l.scaled.visibleWidth,height:l.scaled.visibleHeight}},u=dt(d,h,n,1),g=u.origin.x,I=u.origin.y,_=g+u.size.width,U=I+u.size.height,$=Math.floor((o-1)/r),j=Math.floor((c-1)/r),V=Math.max(0,Math.floor(g/r)-i),B=Math.min($,Math.floor((_-1)/r)+i),H=Math.max(0,Math.floor(I/r)-i),W=Math.min(j,Math.floor((U-1)/r)+i),k=[];for(let b=V;b<=B;b++){const p=b*r,m=Math.min(t,o-p),X=p/s,Z=m/s;for(let S=H;S<=W;S++){const y=S*r,v=Math.min(t,c-y),K=y/s,q=v/s;k.push({id:`p${a.index}-${s}-x${p}-y${y}-w${m}-h${v}`,col:b,row:S,pageRect:{origin:{x:X,y:K},size:{width:Z,height:q}},screenRect:{origin:{x:p,y},size:{width:m,height:v}},status:"queued",srcScale:s,isFallback:!1})}}return k}const x=class x extends ot{constructor(e,i,s){super(e,i),this.tileRendering$=rt(),this.config=s,this.renderCapability=this.registry.getPlugin("render").provides(),this.scrollCapability=this.registry.getPlugin("scroll").provides(),this.viewportCapability=this.registry.getPlugin("viewport").provides(),this.scrollCapability.onScroll(n=>this.calculateVisibleTiles(n),{mode:"throttle",wait:500,throttleMode:"trailing"})}async initialize(){}onCoreStoreUpdated(e,i){e.core.scale!==i.core.scale&&this.calculateVisibleTiles(this.scrollCapability.getMetrics(this.viewportCapability.getMetrics()))}calculateVisibleTiles(e){var a;if(!this.config.enabled){this.dispatch(M([]));return}const i=this.coreState.core.scale,s=this.coreState.core.rotation,n={};for(const l of e.pageVisibilityMetrics){const o=l.pageNumber-1,c=(a=this.coreState.core.document)==null?void 0:a.pages[o];if(!c)continue;const r=Rt({page:c,metric:l,scale:i,rotation:s,tileSize:this.config.tileSize,overlapPx:this.config.overlapPx,extraRings:this.config.extraRings});n[o]=r}this.dispatch(M(n))}onStoreUpdated(e,i){this.tileRendering$.emit(i.visibleTiles)}buildCapability(){return{renderTile:this.renderTile.bind(this),onTileRendering:this.tileRendering$.on}}renderTile(e){if(!this.renderCapability)throw new Error("Render capability not available.");this.dispatch(z(e.pageIndex,e.tile.id,"rendering"));const i=this.renderCapability.renderPageRect({pageIndex:e.pageIndex,rect:e.tile.pageRect,scaleFactor:e.tile.srcScale,dpr:e.dpr});return i.wait(()=>{this.dispatch(z(e.pageIndex,e.tile.id,"ready"))},C),i}};x.id="tiling";let f=x;exports.MARK_TILE_STATUS=O;exports.PdfErrorCode=N;exports.TilingPlugin=f;exports.UPDATE_VISIBLE_TILES=D;exports.ignore=C;
//# sourceMappingURL=tiling-plugin-DX16Gr9b.cjs.map
