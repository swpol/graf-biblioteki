"use strict";const U="SET_DOCUMENT",j="SET_SCALE",B="SET_ROTATION",X="SET_PAGES";function Y(r){const{width:t,height:e}=r;return{width:e,height:t}}function Z(r,t,e){return r=t%2===0?r:Y(r),{width:r.width*e,height:r.height*e}}var J="­",q="​",K="⁠",Q="\uFEFF",tt="￾",et="￿",it=Object.freeze([J,q,K,Q,tt,et]);new RegExp(`[${it.join("")}]`,"g");var R=Object.freeze([{id:0,label:"Normal",css:"normal"},{id:1,label:"Multiply",css:"multiply"},{id:2,label:"Screen",css:"screen"},{id:3,label:"Overlay",css:"overlay"},{id:4,label:"Darken",css:"darken"},{id:5,label:"Lighten",css:"lighten"},{id:6,label:"Color Dodge",css:"color-dodge"},{id:7,label:"Color Burn",css:"color-burn"},{id:8,label:"Hard Light",css:"hard-light"},{id:9,label:"Soft Light",css:"soft-light"},{id:10,label:"Difference",css:"difference"},{id:11,label:"Exclusion",css:"exclusion"},{id:12,label:"Hue",css:"hue"},{id:13,label:"Saturation",css:"saturation"},{id:14,label:"Color",css:"color"},{id:15,label:"Luminosity",css:"luminosity"}]);R.reduce((r,t)=>(r[t.id]=t,r),{});R.reduce((r,t)=>(r[t.css]=t.id,r),{});R.map(r=>({value:r.id,label:r.label}));var rt=Object.freeze({1:"invisible",2:"hidden",4:"print",8:"noZoom",16:"noRotate",32:"noView",64:"readOnly",128:"locked",256:"toggleNoView"});Object.entries(rt).reduce((r,[t,e])=>(r[e]=Number(t),r),{});function w(r,t,e){if(r===t)return!0;if(r==null||t==null)return r===t;const i=typeof r;if(i!==typeof t)return!1;if(i==="object"){e||(e=new Set);const s=st(r,t);if(e.has(s))return!0;e.add(s);const o=Array.isArray(r),a=Array.isArray(t);return o&&a?nt(r,t,e):!o&&!a?at(r,t,e):!1}return!1}function st(r,t){return`${M(r)}__${M(t)}`}let ot=0;const z=new WeakMap;function M(r){return z.has(r)||z.set(r,++ot),z.get(r)}function nt(r,t,e){if(r.length!==t.length)return!1;const i=new Array(t.length).fill(!1);t:for(let s=0;s<r.length;s++){const o=r[s];for(let a=0;a<t.length;a++)if(!i[a]&&w(o,t[a],e)){i[a]=!0;continue t}return!1}return!0}function at(r,t,e){const i=Object.keys(r).sort(),s=Object.keys(t).sort();if(i.length!==s.length)return!1;for(let o=0;o<i.length;o++)if(i[o]!==s[o])return!1;for(const o of i){const a=r[o],n=t[o];if(!w(a,n,e))return!1}return!0}const m=r=>r.pages.map(t=>t.map(e=>({...e,rotatedSize:Z(e.size,r.rotation,1)})));class ht{constructor(t,e){if(this.id=t,this.registry=e,this.debouncedActions={},this.unsubscribeFromState=null,this.unsubscribeFromCoreStore=null,t!==this.constructor.id)throw new Error(`Plugin ID mismatch: ${t} !== ${this.constructor.id}`);this.coreStore=this.registry.getStore(),this.pluginStore=this.coreStore.getPluginStore(this.id),this.unsubscribeFromState=this.pluginStore.subscribeToState((i,s,o)=>{this.onStoreUpdated(o,s)}),this.unsubscribeFromCoreStore=this.coreStore.subscribe((i,s,o)=>{this.onCoreStoreUpdated(o,s)}),this.readyPromise=new Promise(i=>{this.readyResolve=i}),this.readyResolve()}provides(){if(!this._capability){const t=this.buildCapability();this._capability=Object.freeze(t)}return this._capability}get state(){return this.pluginStore.getState()}get coreState(){return this.coreStore.getState()}getState(){return this.pluginStore.getState()}getCoreState(){return this.coreStore.getState()}dispatchCoreAction(t){return this.coreStore.dispatchToCore(t)}dispatchToAllPlugins(t){return this.coreStore.dispatch(t)}dispatch(t){return this.pluginStore.dispatch(t)}debouncedDispatch(t,e=100){const i=Date.now(),s=this.debouncedActions[t.type]||0;return i-s>=e?(this.debouncedActions[t.type]=i,this.dispatch(t),!0):!1}subscribe(t){return this.pluginStore.subscribeToState(t)}subscribeToCoreStore(t){return this.coreStore.subscribe(t)}onStoreUpdated(t,e){}onCoreStoreUpdated(t,e){}destroy(){this.unsubscribeFromState&&(this.unsubscribeFromState(),this.unsubscribeFromState=null),this.unsubscribeFromCoreStore&&(this.unsubscribeFromCoreStore(),this.unsubscribeFromCoreStore=null)}ready(){return this.readyPromise}markReady(){this.readyResolve()}resetReady(){this.readyPromise=new Promise(t=>{this.readyResolve=t})}}class ct{constructor(t,e){this.handler=t,this.options=e,this.lastRun=0,this.handle=i=>{this.options.mode==="debounce"?this.debounce(i):this.throttle(i)}}debounce(t){this.timeoutId&&window.clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout(()=>{this.handler(t),this.timeoutId=void 0},this.options.wait)}throttle(t){if(this.options.mode==="debounce")return;const e=Date.now(),i=this.options.throttleMode||"leading-trailing";e-this.lastRun>=this.options.wait&&(i==="leading-trailing"&&this.handler(t),this.lastRun=e),this.timeoutId&&window.clearTimeout(this.timeoutId),this.timeoutId=window.setTimeout(()=>{this.handler(t),this.lastRun=Date.now(),this.timeoutId=void 0},this.options.wait-(e-this.lastRun))}destroy(){this.timeoutId&&window.clearTimeout(this.timeoutId)}}function p(r,t=w){const e=new Set,i=new Map;let s=r;const o=n=>e.forEach(c=>c(n)),a=(n,c)=>{let l=n,h=()=>{};if(c){const u=new ct(n,c);l=u.handle,h=()=>u.destroy(),i.set(n,{wrapped:l,destroy:h})}return s!==void 0&&l(s),e.add(l),()=>{e.delete(l),h(),i.delete(n)}};return{get value(){return s},emit(n=void 0){(s===void 0||!t(s,n))&&(s=n,o(n))},on:a,off(n){const c=i.get(n);c?(e.delete(c.wrapped),c.destroy(),i.delete(n)):e.delete(n)},clear(){e.clear(),i.forEach(n=>n.destroy()),i.clear()},select(n,c=w){return(l,h)=>{let u;if(s!==void 0){const g=n(s);u=g,l(g)}return a(g=>{const d=n(g);(u===void 0||!c(u,d))&&(u=d,l(d))},h)}}}}var _=(r=>(r[r.Degree0=0]="Degree0",r[r.Degree90=1]="Degree90",r[r.Degree180=2]="Degree180",r[r.Degree270=3]="Degree270",r))(_||{});function D(r){const{width:t,height:e}=r;return{width:e,height:t}}function lt(r,t,e){let i=t.x,s=t.y;switch(e){case 0:i=t.x,s=t.y;break;case 1:i=r.height-t.y,s=t.x;break;case 2:i=r.width-t.x,s=r.height-t.y;break;case 3:i=t.y,s=r.width-t.x;break}return{x:i,y:s}}function T(r,t){return{x:r.x*t,y:r.y*t}}function ut(r,t,e,i){return T(lt(r,t,e),i)}function gt(r,t,e){let i=t.origin.x,s=t.origin.y,o=t.size;switch(e){case 0:break;case 1:i=r.height-t.origin.y-t.size.height,s=t.origin.x,o=D(t.size);break;case 2:i=r.width-t.origin.x-t.size.width,s=r.height-t.origin.y-t.size.height;break;case 3:i=t.origin.y,s=r.width-t.origin.x-t.size.width,o=D(t.size);break}return{origin:{x:i,y:s},size:{width:o.width,height:o.height}}}function dt(r,t){return{origin:{x:r.origin.x*t,y:r.origin.y*t},size:{width:r.size.width*t,height:r.size.height*t}}}function ft(r,t,e,i){return dt(gt(r,t,e),i)}var pt="­",yt="​",St="⁠",bt="\uFEFF",mt="￾",wt="￿",Pt=Object.freeze([pt,yt,St,bt,mt,wt]);new RegExp(`[${Pt.join("")}]`,"g");var F=Object.freeze([{id:0,label:"Normal",css:"normal"},{id:1,label:"Multiply",css:"multiply"},{id:2,label:"Screen",css:"screen"},{id:3,label:"Overlay",css:"overlay"},{id:4,label:"Darken",css:"darken"},{id:5,label:"Lighten",css:"lighten"},{id:6,label:"Color Dodge",css:"color-dodge"},{id:7,label:"Color Burn",css:"color-burn"},{id:8,label:"Hard Light",css:"hard-light"},{id:9,label:"Soft Light",css:"soft-light"},{id:10,label:"Difference",css:"difference"},{id:11,label:"Exclusion",css:"exclusion"},{id:12,label:"Hue",css:"hue"},{id:13,label:"Saturation",css:"saturation"},{id:14,label:"Color",css:"color"},{id:15,label:"Luminosity",css:"luminosity"}]);F.reduce((r,t)=>(r[t.id]=t,r),{});F.reduce((r,t)=>(r[t.css]=t.id,r),{});F.map(r=>({value:r.id,label:r.label}));var xt=Object.freeze({1:"invisible",2:"hidden",4:"print",8:"noZoom",16:"noRotate",32:"noView",64:"readOnly",128:"locked",256:"toggleNoView"});Object.entries(xt).reduce((r,[t,e])=>(r[e]=Number(t),r),{});var y=(r=>(r.Vertical="vertical",r.Horizontal="horizontal",r))(y||{});class ${constructor(t){this.pageGap=t.pageGap??20,this.viewportGap=t.viewportGap??20,this.bufferSize=t.bufferSize??2}getVisibleRange(t,e,i){const s=this.getScrollOffset(t),o=this.getClientSize(t),a=s,n=s+o;let c=0;for(;c<e.length&&(e[c].offset+e[c].height)*i<=a;)c++;let l=c;for(;l<e.length&&e[l].offset*i<=n;)l++;return{start:Math.max(0,c-this.bufferSize),end:Math.min(e.length-1,l+this.bufferSize-1)}}handleScroll(t,e,i){const s=this.getVisibleRange(t,e,i),o=e.slice(s.start,s.end+1),a=this.calculatePageVisibility(o,t,i),n=a.map(f=>f.pageNumber),c=e.slice(s.start,s.end+1).flatMap(f=>f.index),l=this.determineCurrentPage(a),h=e[s.start],u=e[s.end],g=h?h.offset*i:0,d=u?(e[e.length-1].offset+e[e.length-1].height)*i-(u.offset+u.height)*i:0;return{currentPage:l,visiblePages:n,pageVisibilityMetrics:a,renderedPageIndexes:c,scrollOffset:{x:t.scrollLeft,y:t.scrollTop},startSpacing:g,endSpacing:d}}calculatePageVisibility(t,e,i){const s=[];return t.forEach(o=>{o.pageLayouts.forEach(a=>{const n=o.x*i,c=o.y*i,l=n+a.x*i,h=c+a.y*i,u=a.rotatedWidth*i,g=a.rotatedHeight*i,d=e.scrollLeft,f=e.scrollTop,V=d+e.clientWidth,H=f+e.clientHeight,S=Math.max(l,d),b=Math.max(h,f),O=Math.min(l+u,V),A=Math.min(h+g,H);if(S<O&&b<A){const P=O-S,x=A-b,k=u*g,W=P*x;s.push({pageNumber:a.pageNumber,viewportX:S-d,viewportY:b-f,visiblePercentage:W/k*100,original:{pageX:(S-l)/i,pageY:(b-h)/i,visibleWidth:P/i,visibleHeight:x/i,scale:1},scaled:{pageX:S-l,pageY:b-h,visibleWidth:P,visibleHeight:x,scale:i}})}})}),s}determineCurrentPage(t){if(t.length===0)return 1;const e=Math.max(...t.map(s=>s.visiblePercentage)),i=t.filter(s=>s.visiblePercentage===e);return i.length===1?i[0].pageNumber:i.sort((s,o)=>s.pageNumber-o.pageNumber)[0].pageNumber}getRectLocationForPage(t,e){const i=e.find(o=>o.pageNumbers.includes(t));if(!i)return null;const s=i.pageLayouts.find(o=>o.pageNumber===t);return s?{origin:{x:i.x+s.x,y:i.y+s.y},size:{width:s.width,height:s.height}}:null}getScrollPositionForPage(t,e,i,s,o){const a=this.getRectLocationForPage(t,e);if(!a)return null;const n=T(a.origin,i);if(o){const c=ut({width:a.size.width,height:a.size.height},{x:o.x,y:o.y},s,i);return{x:n.x+c.x+this.viewportGap,y:n.y+c.y+this.viewportGap}}return{x:n.x+this.viewportGap,y:n.y+this.viewportGap}}getRectPositionForPage(t,e,i,s,o){const a=this.getRectLocationForPage(t,e);if(!a)return null;const n=T(a.origin,i),c=ft({width:a.size.width,height:a.size.height},o,s,i);return{origin:{x:n.x+c.origin.x,y:n.y+c.origin.y},size:c.size}}}class L extends ${constructor(t){super(t)}createVirtualItems(t){let e=0;return t.map((i,s)=>{let o=0;const a=i.map(h=>{const u={pageNumber:h.index+1,pageIndex:h.index,x:o,y:0,width:h.size.width,height:h.size.height,rotatedWidth:h.rotatedSize.width,rotatedHeight:h.rotatedSize.height};return o+=h.rotatedSize.width+this.pageGap,u}),n=i.reduce((h,u,g)=>h+u.rotatedSize.width+(g<i.length-1?this.pageGap:0),0),c=Math.max(...i.map(h=>h.rotatedSize.height)),l={id:`item-${s}`,x:0,y:e,offset:e,width:n,height:c,pageLayouts:a,pageNumbers:i.map(h=>h.index+1),index:s};return e+=c+this.pageGap,l})}getTotalContentSize(t){if(t.length===0)return{width:0,height:0};const e=Math.max(...t.map(s=>s.width)),i=t[t.length-1].y+t[t.length-1].height;return{width:e,height:i}}getScrollOffset(t){return t.scrollTop}getClientSize(t){return t.clientHeight}}class v extends ${constructor(t){super(t)}createVirtualItems(t){let e=0;return t.map((i,s)=>{let o=0;const a=i.map(h=>{const u={pageNumber:h.index+1,pageIndex:h.index,x:o,y:0,width:h.size.width,height:h.size.height,rotatedWidth:h.rotatedSize.width,rotatedHeight:h.rotatedSize.height};return o+=h.rotatedSize.width+this.pageGap,u}),n=i.reduce((h,u,g)=>h+u.rotatedSize.width+(g<i.length-1?this.pageGap:0),0),c=Math.max(...i.map(h=>h.rotatedSize.height)),l={id:`item-${s}`,x:e,y:0,offset:e,width:n,height:c,pageLayouts:a,pageNumbers:i.map(h=>h.index+1),index:s};return e+=n+this.pageGap,l})}getTotalContentSize(t){if(t.length===0)return{width:0,height:0};const e=t[t.length-1].x+t[t.length-1].width,i=Math.max(...t.map(s=>s.height));return{width:e,height:i}}getScrollOffset(t){return t.scrollLeft}getClientSize(t){return t.clientWidth}}const G="UPDATE_SCROLL_STATE",zt="SET_DESIRED_SCROLL_POSITION",I="UPDATE_TOTAL_PAGES";function N(r){return{type:G,payload:r}}function Lt(r){return{type:I,payload:r}}const vt=(r,t)=>({startSpacing:r.startSpacing,endSpacing:r.endSpacing,totalWidth:r.totalContentSize.width*t,totalHeight:r.totalContentSize.height*t,pageGap:r.pageGap*t,strategy:r.strategy,items:r.renderedPageIndexes.map(e=>({...r.virtualItems[e],pageLayouts:r.virtualItems[e].pageLayouts.map(i=>({...i,rotatedWidth:i.rotatedWidth*t,rotatedHeight:i.rotatedHeight*t,width:i.width*t,height:i.height*t}))}))}),E=class E extends ht{constructor(t,e,i){var s,o,a,n;super(t,e),this.id=t,this.config=i,this.currentScale=1,this.currentRotation=_.Degree0,this.currentPage=1,this.layoutReady=!1,this.layout$=p(),this.scroll$=p(),this.state$=p(),this.scrollerLayout$=p(),this.pageChange$=p(),this.layoutReady$=p(),this.viewport=this.registry.getPlugin("viewport").provides(),this.strategyConfig={pageGap:((s=this.config)==null?void 0:s.pageGap)??10,viewportGap:this.viewport.getViewportGap(),bufferSize:((o=this.config)==null?void 0:o.bufferSize)??2},this.strategy=((a=this.config)==null?void 0:a.strategy)===y.Horizontal?new v(this.strategyConfig):new L(this.strategyConfig),this.initialPage=(n=this.config)==null?void 0:n.initialPage,this.currentScale=this.coreState.core.scale,this.currentRotation=this.coreState.core.rotation,this.viewport.onViewportChange(c=>this.commitMetrics(this.computeMetrics(c)),{mode:"throttle",wait:250}),this.coreStore.onAction(U,(c,l)=>{const h=l.core.pages.length;this.dispatch(Lt(h)),this.pageChange$.emit({pageNumber:this.currentPage,totalPages:h}),this.refreshAll(m(l.core),this.viewport.getMetrics())}),this.coreStore.onAction(B,(c,l)=>this.refreshAll(m(l.core),this.viewport.getMetrics())),this.coreStore.onAction(X,(c,l)=>this.refreshAll(m(l.core),this.viewport.getMetrics()))}computeLayout(t){const e=this.strategy.createVirtualItems(t),i=this.strategy.getTotalContentSize(e);return{virtualItems:e,totalContentSize:i}}computeMetrics(t,e=this.state.virtualItems){return this.strategy.handleScroll(t,e,this.currentScale)}commit(t,e){this.dispatch(N(t)),e!=null&&e.layout&&this.layout$.emit(e.layout),e!=null&&e.metrics&&(this.scroll$.emit(e.metrics),e.metrics.currentPage!==this.currentPage&&(this.currentPage=e.metrics.currentPage,this.pageChange$.emit({pageNumber:this.currentPage,totalPages:this.state.totalPages}))),this.scrollerLayout$.emit(this.getScrollerLayoutFromState())}commitMetrics(t){this.commit(t,{metrics:t})}refreshAll(t,e){const i=this.computeLayout(t),s=this.computeMetrics(e,i.virtualItems);this.commit({...i,...s},{layout:i,metrics:s})}getVirtualItemsFromState(){return this.state.virtualItems||[]}getScrollerLayoutFromState(){const t=this.coreState.core.scale;return vt(this.state,t)}pushScrollLayout(){this.scrollerLayout$.emit(this.getScrollerLayoutFromState())}onStoreUpdated(t,e){this.pushScrollLayout()}onCoreStoreUpdated(t,e){t.core.scale!==e.core.scale&&(this.currentScale=e.core.scale,this.commitMetrics(this.computeMetrics(this.viewport.getMetrics()))),t.core.rotation!==e.core.rotation&&(this.currentRotation=e.core.rotation)}setScrollStrategy(t){if(t===y.Horizontal&&this.strategy instanceof v||t===y.Vertical&&this.strategy instanceof L)return;this.strategy=t===y.Horizontal?new v(this.strategyConfig):new L(this.strategyConfig),this.dispatch(N({strategy:t}));const e=m(this.coreState.core);this.refreshAll(e,this.viewport.getMetrics())}setLayoutReady(){this.layoutReady||(this.layoutReady=!0,this.layoutReady$.emit(!0))}buildCapability(){return{onStateChange:this.state$.on,onLayoutChange:this.layout$.on,onScroll:this.scroll$.on,onPageChange:this.pageChange$.on,onScrollerData:this.scrollerLayout$.on,onLayoutReady:this.layoutReady$.on,getCurrentPage:()=>this.currentPage,getTotalPages:()=>this.state.totalPages,scrollToPage:t=>{const{pageNumber:e,behavior:i="smooth",pageCoordinates:s,center:o=!1}=t,a=this.getVirtualItemsFromState(),n=this.strategy.getScrollPositionForPage(e,a,this.currentScale,this.currentRotation,s);n&&this.viewport.scrollTo({...n,behavior:i,center:o})},scrollToNextPage:(t="smooth")=>{const e=this.getVirtualItemsFromState(),i=e.findIndex(s=>s.pageNumbers.includes(this.currentPage));if(i>=0&&i<e.length-1){const s=e[i+1],o=this.strategy.getScrollPositionForPage(s.pageNumbers[0],e,this.currentScale,this.currentRotation);o&&this.viewport.scrollTo({...o,behavior:t})}},scrollToPreviousPage:(t="smooth")=>{const e=this.getVirtualItemsFromState(),i=e.findIndex(s=>s.pageNumbers.includes(this.currentPage));if(i>0){const s=e[i-1],o=this.strategy.getScrollPositionForPage(s.pageNumbers[0],e,this.currentScale,this.currentRotation);o&&this.viewport.scrollTo({...o,behavior:t})}},getMetrics:this.getMetrics.bind(this),getLayout:this.getLayout.bind(this),getRectPositionForPage:this.getRectPositionForPage.bind(this),getPageGap:()=>this.state.pageGap,getScrollerLayout:()=>this.getScrollerLayoutFromState(),setScrollStrategy:t=>this.setScrollStrategy(t)}}getMetrics(t){const e=t||this.viewport.getMetrics(),i=this.getVirtualItemsFromState();return this.strategy.handleScroll(e,i,this.currentScale)}getLayout(){return{virtualItems:this.state.virtualItems,totalContentSize:this.state.totalContentSize}}getRectPositionForPage(t,e,i,s){return this.strategy.getRectPositionForPage(t+1,this.state.virtualItems,i??this.currentScale,s??this.currentRotation,e)}async initialize(){}async destroy(){this.layout$.clear(),this.scroll$.clear(),this.pageChange$.clear(),this.state$.clear(),this.scrollerLayout$.clear(),this.layoutReady$.clear(),super.destroy()}};E.id="scroll";let C=E;exports.SET_DESIRED_SCROLL_POSITION=zt;exports.ScrollPlugin=C;exports.ScrollStrategy=y;exports.UPDATE_SCROLL_STATE=G;exports.UPDATE_TOTAL_PAGES=I;exports.y=j;
//# sourceMappingURL=scroll-plugin-BGE-Zr8w.cjs.map
